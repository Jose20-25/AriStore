<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AriStore - Gestión de Clientes</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <!-- jsPDF y xlsx para exportación -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <a href="index.html" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                    Volver al Dashboard
                </a>
                <div class="page-title">
                    <div class="page-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div>
                        <h1>Gestión de Clientes</h1>
                        <p>Administra tu base de datos de clientes</p>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="showExportMenu()">
                    <i class="fas fa-download"></i>
                    Exportar
                </button>
                <button class="btn" onclick="openAddClientModal()">
                    <i class="fas fa-user-plus"></i>
                    Agregar Cliente
                </button>
            </div>
        </div>

        <!-- Estadísticas -->
        <div class="stats-grid">
            <div class="stat-card total-clients">
                <div class="stat-header">
                    <div>
                        <div class="stat-number" id="totalClients">127</div>
                        <div class="stat-label">Total de Clientes</div>
                    </div>
                    <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
            </div>
            <div class="stat-card active-clients">
                <div class="stat-header">
                    <div>
                        <div class="stat-number" id="activeClients">89</div>
                        <div class="stat-label">Clientes Activos</div>
                    </div>
                    <div class="stat-icon" style="background: linear-gradient(135deg, #4ecdc4, #44bd87);">
                        <i class="fas fa-user-check"></i>
                    </div>
                </div>
            </div>
            <div class="stat-card new-clients">
                <div class="stat-header">
                    <div>
                        <div class="stat-number" id="newClients">12</div>
                        <div class="stat-label">Nuevos Este Mes</div>
                    </div>
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f9ca24, #f0932b);">
                        <i class="fas fa-user-plus"></i>
                    </div>
                </div>
            </div>
            <div class="stat-card vip-clients">
                <div class="stat-header">
                    <div>
                        <div class="stat-number" id="vipClients">23</div>
                        <div class="stat-label">Clientes VIP</div>
                    </div>
                    <div class="stat-icon" style="background: linear-gradient(135deg, #ff6b6b, #ee5a24);">
                        <i class="fas fa-crown"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenido Principal -->
        <div class="main-content">
            <div class="clients-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-list"></i>
                        Lista de Clientes
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; color: rgba(255, 255, 255, 0.6); font-size: 0.9rem;">
                        <span id="clientCount">127 clientes</span>
                    </div>
                </div>

                <div class="search-filter">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" placeholder="Buscar por nombre, email o teléfono..." id="searchInput">
                    </div>
                    <select class="filter-select" id="statusFilter">
                        <option value="">Todos los estados</option>
                        <option value="activo">Activos</option>
                        <option value="inactivo">Inactivos</option>
                        <option value="vip">VIP</option>
                        <option value="nuevo">Nuevos</option>
                    </select>
                    <select class="filter-select" id="cityFilter">
                        <option value="">Todas las ciudades</option>
                        <option value="madrid">Madrid</option>
                        <option value="barcelona">Barcelona</option>
                        <option value="valencia">Valencia</option>
                        <option value="sevilla">Sevilla</option>
                    </select>
                </div>

                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>Cliente</th>
                            <th>Código</th>
                            <th>Email</th>
                            <th>Teléfono</th>
                            <th>Ciudad</th>
                            <th>Compras</th>
                            <th>Total Gastado</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="clientsTableBody">
                        <!-- Los clientes se cargarán dinámicamente -->
                    </tbody>
                </table>
            </div>

            <div class="sidebar">
                <div class="quick-actions">
                    <h3>
                        <i class="fas fa-bolt"></i>
                        Acciones Rápidas
                    </h3>
                    <a href="#" class="quick-action-btn" onclick="openAddClientModal()">
                        <i class="fas fa-user-plus"></i>
                        Agregar Cliente
                    </a>
                    <a href="#" class="quick-action-btn" onclick="bulkEmail()">
                        <i class="fas fa-envelope"></i>
                        Email Masivo
                    </a>
                    <a href="#" class="quick-action-btn" onclick="birthdayReminders()">
                        <i class="fas fa-birthday-cake"></i>
                        Cumpleaños
                    </a>
                    <a href="#" class="quick-action-btn" onclick="clientsReport()">
                        <i class="fas fa-chart-pie"></i>
                        Reporte de Clientes
                    </a>
                </div>

                <div class="recent-activity">
                    <h3 style="color: #ffffff; font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-clock"></i>
                        Actividad Reciente
                    </h3>
                    <div class="activity-item">
                        <div class="activity-icon" style="background: linear-gradient(135deg, #4ecdc4, #44bd87);">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Cliente agregado</div>
                            <div class="activity-time">Hace 15 minutos</div>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon" style="background: linear-gradient(135deg, #f9ca24, #f0932b);">
                            <i class="fas fa-edit"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Datos actualizados</div>
                            <div class="activity-time">Hace 32 minutos</div>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Nueva compra</div>
                            <div class="activity-time">Hace 1 hora</div>
                        </div>
                    </div>
                </div>

                <!-- Top Clientes -->
                <div class="recent-activity">
                    <h3 style="color: #ffffff; font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-trophy"></i>
                        Top Clientes
                    </h3>
                    <div id="topClients">
                        <!-- Se cargará dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar/Editar Cliente -->
    <div class="modal" id="clientModal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user"></i>
                    <span id="modalTitle">Agregar Cliente</span>
                </div>
                <button class="close-btn" onclick="closeClientModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="clientForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Nombre Completo</label>
                        <input type="text" class="form-input" id="clientName" placeholder="Ej: Juan Pérez López" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="clientEmail" placeholder="cliente@email.com" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Teléfono</label>
                        <input type="tel" class="form-input" id="clientPhone" placeholder="+34 600 123 456" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Código Cliente</label>
                        <input type="text" class="form-input" id="clientCode" placeholder="Se genera automáticamente" readonly style="background: rgba(255,255,255,0.05);">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Dirección</label>
                        <input type="text" class="form-input" id="clientAddress" placeholder="Calle, número, piso">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Ciudad</label>
                        <input type="text" class="form-input" id="clientCity" placeholder="Ej: Madrid, Barcelona, Valencia..." required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estado</label>
                        <select class="form-select" id="clientStatus" required>
                            <option value="activo">Activo</option>
                            <option value="inactivo">Inactivo</option>
                            <option value="vip">VIP</option>
                            <option value="nuevo">Nuevo</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notas</label>
                    <textarea class="form-textarea" id="clientNotes" placeholder="Información adicional sobre el cliente (opcional)"></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeClientModal()">
                        Cancelar
                    </button>
                    <button type="submit" class="btn">
                        <i class="fas fa-save"></i>
                        Guardar Cliente
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Detalles del Cliente -->
    <div class="modal" id="clientDetailsModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-user-circle"></i>
                    <span>Detalles del Cliente</span>
                </div>
                <button class="close-btn" onclick="closeClientDetailsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="clientDetailsContent">
                <!-- El contenido se cargará dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Modal de Exportación -->
    <div class="modal" id="exportModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-download"></i>
                    <span>Exportar Clientes</span>
                </div>
                <button class="close-btn" onclick="closeExportModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="padding: 8px 0;">
                <button class="btn" style="width: 100%; margin-bottom: 12px;" onclick="exportToPDF()">
                    <i class="fas fa-file-pdf"></i>
                    Exportar a PDF
                </button>
                <button class="btn btn-secondary" style="width: 100%; margin-bottom: 12px;" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i>
                    Exportar a Excel
                </button>
                <button class="btn btn-secondary" style="width: 100%;" onclick="exportToCSV()">
                    <i class="fas fa-file-csv"></i>
                    Exportar a CSV
                </button>
            </div>
        </div>
    </div>

    <script>
        // Datos de clientes
        let clientsData = [];
        let currentEditingId = null;

        // Cargar datos desde localStorage o usar datos por defecto
        function loadClientsData() {
            const savedData = localStorage.getItem('aristore_clients');
            if (savedData) {
                clientsData = JSON.parse(savedData);
            } else {
                // Datos por defecto si no hay datos guardados
                clientsData = [
                    {
                        id: 1,
                        code: "CLI-001",
                        name: "Ana García Martín",
                        email: "ana.garcia@email.com",
                        phone: "+34 661 234 567",
                        address: "Calle Gran Vía, 45, 3º A",
                        city: "Madrid",
                        status: "vip",
                        notes: "Cliente VIP desde 2020. Prefiere productos premium.",
                        totalPurchases: 23,
                        totalSpent: 2890.50,
                        lastPurchase: "2024-07-25",
                        dateAdded: "2020-01-15"
                    },
                    {
                        id: 2,
                        code: "CLI-002",
                        name: "Carlos Rodríguez López",
                        email: "carlos.rodriguez@email.com",
                        phone: "+34 622 345 678",
                        address: "Avenida Diagonal, 120, 2º B",
                        city: "Barcelona",
                        status: "activo",
                        notes: "Interesado en tecnología móvil.",
                        totalPurchases: 8,
                        totalSpent: 567.30,
                        lastPurchase: "2024-07-20",
                        dateAdded: "2023-05-10"
                    },
                    {
                        id: 3,
                        code: "CLI-003",
                        name: "María López Fernández",
                        email: "maria.lopez@email.com",
                        phone: "+34 633 456 789",
                        address: "Calle Valencia, 78, 1º",
                        city: "Valencia",
                        status: "activo",
                        notes: "Compra regularmente accesorios para iPhone.",
                        totalPurchases: 15,
                        totalSpent: 945.80,
                        lastPurchase: "2024-07-18",
                        dateAdded: "2022-03-20"
                    },
                    {
                        id: 4,
                        code: "CLI-004",
                        name: "David Martínez Ruiz",
                        email: "david.martinez@email.com",
                        phone: "+34 644 567 890",
                        address: "Plaza Mayor, 12, 4º C",
                        city: "Sevilla",
                        status: "nuevo",
                        notes: "Cliente recién registrado. Primera compra pendiente.",
                        totalPurchases: 1,
                        totalSpent: 89.99,
                        lastPurchase: "2024-07-28",
                        dateAdded: "2024-07-28"
                    },
                    {
                        id: 5,
                        code: "CLI-005",
                        name: "Laura Sánchez Torres",
                        email: "laura.sanchez@email.com",
                        phone: "+34 655 678 901",
                        address: "Calle Alcalá, 200, 5º D",
                        city: "Madrid",
                        status: "vip",
                        notes: "Excelente cliente. Siempre recomienda a amigos.",
                        totalPurchases: 31,
                        totalSpent: 3456.75,
                        lastPurchase: "2024-07-26",
                        dateAdded: "2019-08-05"
                    },
                    {
                        id: 6,
                        code: "CLI-006",
                        name: "Javier Moreno Gil",
                        email: "javier.moreno@email.com",
                        phone: "+34 666 789 012",
                        address: "Rambla Catalunya, 56, 3º",
                        city: "Barcelona",
                        status: "inactivo",
                        notes: "No compra desde hace 6 meses. Contactar para promociones.",
                        totalPurchases: 12,
                        totalSpent: 678.45,
                        lastPurchase: "2024-01-15",
                        dateAdded: "2021-11-30"
                    }
                ];
                saveClientsData();
            }
        }

        // Guardar datos en localStorage
        function saveClientsData() {
            localStorage.setItem('aristore_clients', JSON.stringify(clientsData));
        }

        // Generar código automático para cliente
        function generateClientCode() {
            const maxId = Math.max(0, ...clientsData.map(c => c.id));
            const nextId = maxId + 1;
            return `CLI-${nextId.toString().padStart(3, '0')}`;
        }

        // Inicializar la página
        document.addEventListener('DOMContentLoaded', function() {
            loadClientsData();
            updateStats();
            renderClientsTable();
            renderTopClients();
            setupEventListeners();
        });

        // Configurar event listeners
        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', filterClients);
            document.getElementById('statusFilter').addEventListener('change', filterClients);
            document.getElementById('cityFilter').addEventListener('change', filterClients);
            document.getElementById('clientForm').addEventListener('submit', handleClientSubmit);
        }

        // Actualizar estadísticas
        function updateStats() {
            const totalClients = clientsData.length;
            const activeClients = clientsData.filter(client => client.status === 'activo' || client.status === 'vip').length;
            const vipClients = clientsData.filter(client => client.status === 'vip').length;
            
            // Clientes nuevos este mes
            const thisMonth = new Date().getMonth();
            const thisYear = new Date().getFullYear();
            const newClients = clientsData.filter(client => {
                const addedDate = new Date(client.dateAdded);
                return addedDate.getMonth() === thisMonth && addedDate.getFullYear() === thisYear;
            }).length;

            document.getElementById('totalClients').textContent = totalClients;
            document.getElementById('activeClients').textContent = activeClients;
            document.getElementById('newClients').textContent = newClients;
            document.getElementById('vipClients').textContent = vipClients;
            document.getElementById('clientCount').textContent = `${totalClients} clientes`;
        }

        // Renderizar tabla de clientes
        function renderClientsTable(data = clientsData) {
            const tbody = document.getElementById('clientsTableBody');
            tbody.innerHTML = '';

            data.forEach(client => {
                const row = document.createElement('tr');
                
                const statusInfo = getStatusInfo(client.status);
                const cityName = getCityName(client.city);

                row.innerHTML = `
                    <td>
                        <div class="product-info">
                            <div class="product-image">
                                <i class="fas fa-user-circle" style="font-size: 2rem; color: #667eea;"></i>
                            </div>
                            <div class="product-details">
                                <h4>${client.name}</h4>
                                <p>Cliente desde: ${new Date(client.dateAdded).toLocaleDateString('es-ES')}</p>
                            </div>
                        </div>
                    </td>
                    <td style="color: #4ecdc4; font-weight: 600;">${client.code}</td>
                    <td style="color: rgba(255,255,255,0.8);">${client.email}</td>
                    <td style="color: rgba(255,255,255,0.8);">${client.phone}</td>
                    <td style="color: rgba(255,255,255,0.8);">${cityName}</td>
                    <td style="color: #4ecdc4; font-weight: 600;">${client.totalPurchases}</td>
                    <td style="color: #4ecdc4; font-weight: 600;">$${client.totalSpent.toLocaleString('es-ES', {minimumFractionDigits: 2})}</td>
                    <td>
                        <span class="stock-badge ${statusInfo.class}">${statusInfo.label}</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="viewClientDetails(${client.id})" title="Ver detalles">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="editClient(${client.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteClient(${client.id})" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Renderizar top clientes
        function renderTopClients() {
            const topClients = [...clientsData]
                .sort((a, b) => b.totalSpent - a.totalSpent)
                .slice(0, 5);

            const container = document.getElementById('topClients');
            container.innerHTML = topClients.map((client, index) => `
                <div class="activity-item">
                    <div class="activity-icon" style="background: linear-gradient(135deg, #667eea, #764ba2); font-size: 0.8rem; font-weight: bold;">
                        ${index + 1}
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${client.name}</div>
                        <div class="activity-time">$${client.totalSpent.toLocaleString('es-ES', {minimumFractionDigits: 2})}</div>
                    </div>
                </div>
            `).join('');
        }

        // Obtener información del estado
        function getStatusInfo(status) {
            const statusMap = {
                'activo': { class: 'high', label: 'Activo' },
                'inactivo': { class: 'out', label: 'Inactivo' },
                'vip': { class: 'vip', label: 'VIP' },
                'nuevo': { class: 'medium', label: 'Nuevo' }
            };
            return statusMap[status] || { class: 'medium', label: status };
        }

        // Obtener nombre de ciudad
        function getCityName(city) {
            return city || 'No especificada';
        }

        // Filtrar clientes
        function filterClients() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const cityFilter = document.getElementById('cityFilter').value;

            let filteredData = clientsData.filter(client => {
                const matchesSearch = client.name.toLowerCase().includes(searchTerm) || 
                                    client.email.toLowerCase().includes(searchTerm) ||
                                    client.phone.includes(searchTerm) ||
                                    client.city.toLowerCase().includes(searchTerm);
                
                const matchesStatus = !statusFilter || client.status === statusFilter;
                const matchesCity = !cityFilter || client.city.toLowerCase().includes(cityFilter.toLowerCase());

                return matchesSearch && matchesStatus && matchesCity;
            });

            renderClientsTable(filteredData);
            document.getElementById('clientCount').textContent = `${filteredData.length} clientes`;
        }

        // Abrir modal para agregar cliente
        function openAddClientModal() {
            currentEditingId = null;
            document.getElementById('modalTitle').textContent = 'Agregar Cliente';
            document.getElementById('clientForm').reset();
            document.getElementById('clientStatus').value = 'nuevo';
            document.getElementById('clientCode').value = generateClientCode();
            document.getElementById('clientModal').classList.add('show');
        }

        // Cerrar modal
        function closeClientModal() {
            document.getElementById('clientModal').classList.remove('show');
            currentEditingId = null;
        }

        // Editar cliente
        function editClient(id) {
            const client = clientsData.find(c => c.id === id);
            if (!client) {
                showAlert('Cliente no encontrado', 'error');
                return;
            }

            currentEditingId = id;
            document.getElementById('modalTitle').textContent = 'Editar Cliente';
            
            // Llenar campos del formulario
            document.getElementById('clientName').value = client.name || '';
            document.getElementById('clientEmail').value = client.email || '';
            document.getElementById('clientPhone').value = client.phone || '';
            document.getElementById('clientCode').value = client.code || '';
            document.getElementById('clientAddress').value = client.address || '';
            document.getElementById('clientCity').value = client.city || '';
            document.getElementById('clientStatus').value = client.status || 'activo';
            document.getElementById('clientNotes').value = client.notes || '';

            document.getElementById('clientModal').classList.add('show');
        }

        // Ver detalles del cliente
        function viewClientDetails(id) {
            const client = clientsData.find(c => c.id === id);
            if (!client) {
                showAlert('Cliente no encontrado', 'error');
                return;
            }

            const statusInfo = getStatusInfo(client.status);
            const cityName = getCityName(client.city);
            const lastPurchaseDate = client.lastPurchase ? new Date(client.lastPurchase).toLocaleDateString('es-ES') : 'Nunca';

            const content = document.getElementById('clientDetailsContent');
            content.innerHTML = `
                <div style="padding: 24px;">
                    <!-- Header del cliente -->
                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <div style="font-size: 4rem; color: #667eea;">
                            <i class="fas fa-user-circle"></i>
                        </div>
                        <div>
                            <h2 style="color: #fff; margin-bottom: 8px;">${client.name}</h2>
                            <p style="color: rgba(255,255,255,0.6); margin-bottom: 4px;">${client.email}</p>
                            <p style="color: rgba(255,255,255,0.6); margin-bottom: 8px;">Código: ${client.code}</p>
                            <span class="stock-badge ${statusInfo.class}">${statusInfo.label}</span>
                        </div>
                    </div>

                    <!-- Información personal -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                        <div>
                            <h3 style="color: #4ecdc4; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-user"></i>
                                Información Personal
                            </h3>
                            <div style="background: rgba(255,255,255,0.02); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: rgba(255,255,255,0.8);">Código:</strong>
                                    <span style="color: #4ecdc4; margin-left: 8px; font-weight: 600;">${client.code}</span>
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: rgba(255,255,255,0.8);">Teléfono:</strong>
                                    <span style="color: #fff; margin-left: 8px;">${client.phone}</span>
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: rgba(255,255,255,0.8);">Ciudad:</strong>
                                    <span style="color: #fff; margin-left: 8px;">${cityName}</span>
                                </div>
                                <div>
                                    <strong style="color: rgba(255,255,255,0.8);">Cliente desde:</strong>
                                    <span style="color: #fff; margin-left: 8px;">${new Date(client.dateAdded).toLocaleDateString('es-ES')}</span>
                                </div>
                            </div>
                        </div>

                        <div>
                            <h3 style="color: #4ecdc4; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-shopping-cart"></i>
                                Estadísticas de Compras
                            </h3>
                            <div style="background: rgba(255,255,255,0.02); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: rgba(255,255,255,0.8);">Total de compras:</strong>
                                    <span style="color: #4ecdc4; margin-left: 8px; font-weight: 600;">${client.totalPurchases}</span>
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: rgba(255,255,255,0.8);">Total gastado:</strong>
                                    <span style="color: #4ecdc4; margin-left: 8px; font-weight: 600;">$${client.totalSpent.toLocaleString('es-ES', {minimumFractionDigits: 2})}</span>
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <strong style="color: rgba(255,255,255,0.8);">Promedio por compra:</strong>
                                    <span style="color: #4ecdc4; margin-left: 8px; font-weight: 600;">$${(client.totalSpent / Math.max(client.totalPurchases, 1)).toFixed(2)}</span>
                                </div>
                                <div>
                                    <strong style="color: rgba(255,255,255,0.8);">Última compra:</strong>
                                    <span style="color: #fff; margin-left: 8px;">${lastPurchaseDate}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dirección -->
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #4ecdc4; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-map-marker-alt"></i>
                            Dirección
                        </h3>
                        <div style="background: rgba(255,255,255,0.02); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                            <p style="color: #fff; margin-bottom: 8px;">${client.address || 'No especificada'}</p>
                            <p style="color: rgba(255,255,255,0.8);">${cityName}</p>
                        </div>
                    </div>

                    <!-- Notas -->
                    ${client.notes ? `
                        <div>
                            <h3 style="color: #4ecdc4; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-sticky-note"></i>
                                Notas
                            </h3>
                            <div style="background: rgba(255,255,255,0.02); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05);">
                                <p style="color: #fff; line-height: 1.6;">${client.notes}</p>
                            </div>
                        </div>
                    ` : ''}

                    <!-- Acciones -->
                    <div style="display: flex; gap: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <button onclick="editClient(${client.id}); closeClientDetailsModal();" class="btn" style="flex: 1;">
                            <i class="fas fa-edit"></i>
                            Editar Cliente
                        </button>
                        <button onclick="sendEmail('${client.email}')" class="btn btn-secondary" style="flex: 1;">
                            <i class="fas fa-envelope"></i>
                            Enviar Email
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('clientDetailsModal').classList.add('show');
        }

        // Cerrar modal de detalles
        function closeClientDetailsModal() {
            document.getElementById('clientDetailsModal').classList.remove('show');
        }

        // Manejar envío del formulario
        function handleClientSubmit(e) {
            e.preventDefault();

            const clientData = {
                name: document.getElementById('clientName').value,
                email: document.getElementById('clientEmail').value,
                phone: document.getElementById('clientPhone').value,
                code: document.getElementById('clientCode').value,
                address: document.getElementById('clientAddress').value,
                city: document.getElementById('clientCity').value,
                status: document.getElementById('clientStatus').value,
                notes: document.getElementById('clientNotes').value
            };

            // Validar email único
            const isDuplicateEmail = clientsData.some(c => 
                c.email === clientData.email && c.id !== currentEditingId
            );

            if (isDuplicateEmail) {
                showAlert('El email ya está registrado para otro cliente.', 'error');
                return;
            }

            if (currentEditingId) {
                // Editar cliente existente
                const index = clientsData.findIndex(c => c.id === currentEditingId);
                if (index !== -1) {
                    clientsData[index] = { ...clientsData[index], ...clientData };
                    showAlert('Cliente actualizado correctamente', 'success');
                }
            } else {
                // Agregar nuevo cliente
                const newId = Math.max(0, ...clientsData.map(c => c.id)) + 1;
                const newClient = {
                    ...clientData,
                    id: newId,
                    totalPurchases: 0,
                    totalSpent: 0,
                    lastPurchase: null,
                    dateAdded: new Date().toISOString().split('T')[0]
                };
                clientsData.push(newClient);
                showAlert('Cliente agregado correctamente', 'success');
            }

            saveClientsData();
            updateStats();
            renderClientsTable();
            renderTopClients();
            closeClientModal();
        }

        // Eliminar cliente
        function deleteClient(id) {
            const client = clientsData.find(c => c.id === id);
            if (!client) {
                showAlert('Cliente no encontrado', 'error');
                return;
            }

            if (confirm(`¿Estás seguro de que deseas eliminar a "${client.name}"?\n\nEsta acción no se puede deshacer y se perderá todo el historial de compras.`)) {
                clientsData = clientsData.filter(c => c.id !== id);
                saveClientsData();
                updateStats();
                renderClientsTable();
                renderTopClients();
                showAlert('Cliente eliminado correctamente', 'success');
            }
        }

        // Enviar email
        function sendEmail(email) {
            window.open(`mailto:${email}`, '_blank');
        }

        // Mostrar menú de exportación
        function showExportMenu() {
            document.getElementById('exportModal').classList.add('show');
        }

        // Cerrar modal de exportación
        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('show');
        }

        // Exportar a PDF
        function exportToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(20);
                doc.text('AriStore - Reporte de Clientes', 20, 20);
                
                doc.setFontSize(12);
                doc.text(`Fecha de generación: ${new Date().toLocaleDateString('es-ES')}`, 20, 30);
                doc.text(`Total de clientes: ${clientsData.length}`, 20, 40);
                
                const tableData = clientsData.map(client => [
                    client.name,
                    client.code,
                    client.email,
                    client.phone,
                    getCityName(client.city),
                    client.totalPurchases.toString(),
                    `$${client.totalSpent.toFixed(2)}`,
                    getStatusInfo(client.status).label
                ]);
                
                doc.autoTable({
                    head: [['Nombre', 'Código', 'Email', 'Teléfono', 'Ciudad', 'Compras', 'Total Gastado', 'Estado']],
                    body: tableData,
                    startY: 50,
                    styles: { fontSize: 8, cellPadding: 3 },
                    headStyles: { fillColor: [102, 126, 234], textColor: 255 }
                });
                
                doc.save(`AriStore_Clientes_${new Date().toISOString().split('T')[0]}.pdf`);
                closeExportModal();
                showAlert('Reporte PDF generado correctamente', 'success');
            } catch (error) {
                console.error('Error al generar PDF:', error);
                showAlert('Error al generar el PDF', 'error');
            }
        }

        // Exportar a Excel
        function exportToExcel() {
            try {
                const excelData = clientsData.map(client => ({
                    'Nombre': client.name,
                    'Código': client.code,
                    'Email': client.email,
                    'Teléfono': client.phone,
                    'Dirección': client.address || '',
                    'Ciudad': getCityName(client.city),
                    'Estado': getStatusInfo(client.status).label,
                    'Total Compras': client.totalPurchases,
                    'Total Gastado': client.totalSpent,
                    'Última Compra': client.lastPurchase || '',
                    'Fecha Registro': client.dateAdded,
                    'Notas': client.notes || ''
                }));
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                XLSX.utils.book_append_sheet(wb, ws, 'Clientes');
                XLSX.writeFile(wb, `AriStore_Clientes_${new Date().toISOString().split('T')[0]}.xlsx`);
                
                closeExportModal();
                showAlert('Archivo Excel generado correctamente', 'success');
            } catch (error) {
                console.error('Error al generar Excel:', error);
                showAlert('Error al generar el archivo Excel', 'error');
            }
        }

        // Exportar a CSV
        function exportToCSV() {
            try {
                const csvData = clientsData.map(client => ({
                    'Nombre': client.name,
                    'Código': client.code,
                    'Email': client.email,
                    'Teléfono': client.phone,
                    'Ciudad': getCityName(client.city),
                    'Estado': getStatusInfo(client.status).label,
                    'Total Compras': client.totalPurchases,
                    'Total Gastado': client.totalSpent,
                    'Fecha Registro': client.dateAdded
                }));
                
                const ws = XLSX.utils.json_to_sheet(csvData);
                const csv = XLSX.utils.sheet_to_csv(ws);
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `AriStore_Clientes_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                closeExportModal();
                showAlert('Archivo CSV generado correctamente', 'success');
            } catch (error) {
                console.error('Error al generar CSV:', error);
                showAlert('Error al generar el archivo CSV', 'error');
            }
        }

        // Funciones de acciones rápidas
        function bulkEmail() {
            const activeEmails = clientsData
                .filter(client => client.status === 'activo' || client.status === 'vip')
                .map(client => client.email)
                .join(';');
            
            if (activeEmails) {
                window.open(`mailto:?bcc=${activeEmails}`, '_blank');
            } else {
                showAlert('No hay clientes activos para enviar emails', 'error');
            }
        }

        function birthdayReminders() {
            showAlert('Función de cumpleaños deshabilitada (campo fecha de nacimiento removido)', 'info');
        }

        function clientsReport() {
            // Generar reporte detallado en nueva ventana
            const reportWindow = window.open('', 'ReporteClientes', 'width=900,height=700');
            
            const totalSpent = clientsData.reduce((sum, client) => sum + client.totalSpent, 0);
            const averageSpent = totalSpent / clientsData.length;
            const topClient = clientsData.reduce((top, client) => client.totalSpent > top.totalSpent ? client : top, clientsData[0]);

            const reportHTML = `
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8">
                    <title>AriStore - Reporte de Clientes</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #667eea; padding-bottom: 20px; }
                        .logo { font-size: 2rem; font-weight: bold; color: #667eea; }
                        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
                        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; }
                        .stat-number { font-size: 1.8rem; font-weight: bold; color: #667eea; }
                        .stat-label { color: #666; font-size: 0.9rem; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background-color: #667eea; color: white; }
                        tr:nth-child(even) { background-color: #f2f2f2; }
                        .status-vip { color: #ff6b6b; font-weight: bold; }
                        .status-activo { color: #4ecdc4; font-weight: bold; }
                        .status-nuevo { color: #f9ca24; font-weight: bold; }
                        .status-inactivo { color: #666; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="logo">AriStore</div>
                        <h2>Reporte Detallado de Clientes</h2>
                        <p>Generado el: ${new Date().toLocaleDateString('es-ES', { 
                            year: 'numeric', month: 'long', day: 'numeric',
                            hour: '2-digit', minute: '2-digit'
                        })}</p>
                    </div>
                    
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number">${clientsData.length}</div>
                            <div class="stat-label">Total Clientes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">$${totalSpent.toLocaleString('es-ES', {minimumFractionDigits: 2})}</div>
                            <div class="stat-label">Ingresos Totales</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">$${averageSpent.toFixed(2)}</div>
                            <div class="stat-label">Promedio por Cliente</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${clientsData.filter(c => c.status === 'vip').length}</div>
                            <div class="stat-label">Clientes VIP</div>
                        </div>
                    </div>

                    <h3>Top Cliente: ${topClient.name} - $${topClient.totalSpent.toLocaleString('es-ES', {minimumFractionDigits: 2})}</h3>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Email</th>
                                <th>Ciudad</th>
                                <th>Compras</th>
                                <th>Total Gastado</th>
                                <th>Estado</th>
                                <th>Última Compra</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${clientsData.map(client => `
                                <tr>
                                    <td>${client.name}</td>
                                    <td>${client.email}</td>
                                    <td>${getCityName(client.city)}</td>
                                    <td>${client.totalPurchases}</td>
                                    <td>$${client.totalSpent.toLocaleString('es-ES', {minimumFractionDigits: 2})}</td>
                                    <td class="status-${client.status}">${getStatusInfo(client.status).label}</td>
                                    <td>${client.lastPurchase ? new Date(client.lastPurchase).toLocaleDateString('es-ES') : 'Nunca'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="text-align: center; margin-top: 30px;">
                        <button onclick="window.print()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Imprimir Reporte
                        </button>
                    </div>
                </body>
                </html>
            `;
            
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
            
            showAlert('Reporte generado en nueva ventana', 'success');
        }

        // Mostrar alertas
        function showAlert(message, type = 'info') {
            const alert = document.createElement('div');
            alert.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: rgba(28, 28, 38, 0.95);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                color: #ffffff;
                z-index: 1001;
                backdrop-filter: blur(20px);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            
            const colors = {
                success: '#4ecdc4',
                error: '#ff6b6b',
                info: '#667eea'
            };
            alert.style.borderLeftColor = colors[type];
            alert.style.borderLeftWidth = '4px';
            
            alert.textContent = message;
            document.body.appendChild(alert);
            
            setTimeout(() => {
                alert.style.transform = 'translateX(0)';
            }, 100);
            
            setTimeout(() => {
                alert.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(alert);
                }, 300);
            }, 3000);
        }

        // Cerrar modales al hacer clic fuera
        document.getElementById('clientModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeClientModal();
            }
        });

        document.getElementById('clientDetailsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeClientDetailsModal();
            }
        });

        document.getElementById('exportModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeExportModal();
            }
        });
    </script>

    <!-- Agregar estilos específicos para el estado VIP -->
    <style>
        .stock-badge.vip {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            font-weight: 600;
        }
    </style>
</body>
</html>
