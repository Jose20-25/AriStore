<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AriStore - Gestión de Inventario</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <!-- jsPDF y xlsx para exportación -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <a href="index.html" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                    Volver al Dashboard
                </a>
                <div class="page-title">
                    <div class="page-icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <div>
                        <h1>Gestión de Inventario</h1>
                        <p>Administra tu stock de productos</p>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" onclick="showExportMenu()">
                    <i class="fas fa-download"></i>
                    Exportar
                </button>
                <button class="btn" onclick="openAddProductModal()">
                    <i class="fas fa-plus"></i>
                    Agregar Producto
                </button>
            </div>
        </div>

        <!-- Estadísticas -->
        <div class="stats-grid">
            <div class="stat-card total-products">
                <div class="stat-header">
                    <div>
                        <div class="stat-number" id="totalProducts">245</div>
                        <div class="stat-label">Total de Productos</div>
                    </div>
                    <div class="stat-icon" style="background: linear-gradient(135deg, #ff6b6b, #ee5a24);">
                        <i class="fas fa-boxes"></i>
                    </div>
                </div>
            </div>
            <div class="stat-card low-stock">
                <div class="stat-header">
                    <div>
                        <div class="stat-number" id="lowStock">8</div>
                        <div class="stat-label">Stock Bajo</div>
                    </div>
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f9ca24, #f0932b);">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                </div>
            </div>
            <div class="stat-card out-stock">
                <div class="stat-header">
                    <div>
                        <div class="stat-number" id="outStock">3</div>
                        <div class="stat-label">Sin Stock</div>
                    </div>
                    <div class="stat-icon" style="background: linear-gradient(135deg, #ff4757, #c44569);">
                        <i class="fas fa-times-circle"></i>
                    </div>
                </div>
            </div>
            <div class="stat-card categories">
                <div class="stat-header">
                    <div>
                        <div class="stat-number" id="totalCategories">12</div>
                        <div class="stat-label">Categorías</div>
                    </div>
                    <div class="stat-icon" style="background: linear-gradient(135deg, #4ecdc4, #44bd87);">
                        <i class="fas fa-tags"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenido Principal -->
        <div class="main-content">
            <div class="inventory-section">
                <div class="section-header">
                    <div class="section-title">
                        <i class="fas fa-list"></i>
                        Lista de Productos
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; color: rgba(255, 255, 255, 0.6); font-size: 0.9rem;">
                        <span id="productCount">245 productos</span>
                    </div>
                </div>

                <div class="search-filter">
                    <div class="search-box">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" placeholder="Buscar por nombre o código..." id="searchInput">
                    </div>
                    <select class="filter-select" id="categoryFilter">
                        <option value="">Todas las categorías</option>
                        <option value="auriculares">Auriculares</option>
                        <option value="cargadores">Cargadores</option>
                        <option value="fundas">Fundas</option>
                        <option value="cables">Cables</option>
                        <option value="smartwatch">Smartwatch</option>
                        <option value="otros">Otros</option>
                    </select>
                    <select class="filter-select" id="stockFilter">
                        <option value="">Todo el stock</option>
                        <option value="high">Stock Alto</option>
                        <option value="medium">Stock Medio</option>
                        <option value="low">Stock Bajo</option>
                        <option value="out">Sin Stock</option>
                    </select>
                </div>

                <table class="inventory-table">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Categoría</th>
                            <th>Stock</th>
                            <th>P. Compra</th>
                            <th>P. Venta</th>
                            <th>Margen</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody">
                        <!-- Los productos se cargarán dinámicamente -->
                    </tbody>
                </table>
            </div>

            <div class="sidebar">
                <div class="quick-actions">
                    <h3>
                        <i class="fas fa-bolt"></i>
                        Acciones Rápidas
                    </h3>
                    <a href="#" class="quick-action-btn" onclick="openAddProductModal()">
                        <i class="fas fa-plus"></i>
                        Agregar Producto
                    </a>
                    <a href="#" class="quick-action-btn" onclick="bulkUpdate()">
                        <i class="fas fa-edit"></i>
                        Actualización Masiva
                    </a>
                    <a href="#" class="quick-action-btn" onclick="lowStockAlert()">
                        <i class="fas fa-exclamation-triangle"></i>
                        Alertas de Stock
                    </a>
                    <a href="#" class="quick-action-btn" onclick="generateReport()">
                        <i class="fas fa-chart-bar"></i>
                        Generar Reporte
                    </a>
                </div>

                <div class="recent-activity">
                    <h3 style="color: #ffffff; font-size: 1.1rem; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-clock"></i>
                        Actividad Reciente
                    </h3>
                    <div class="activity-item">
                        <div class="activity-icon" style="background: linear-gradient(135deg, #4ecdc4, #44bd87);">
                            <i class="fas fa-plus"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Producto agregado</div>
                            <div class="activity-time">Hace 5 minutos</div>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon" style="background: linear-gradient(135deg, #f9ca24, #f0932b);">
                            <i class="fas fa-edit"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Stock actualizado</div>
                            <div class="activity-time">Hace 12 minutos</div>
                        </div>
                    </div>
                    <div class="activity-item">
                        <div class="activity-icon" style="background: linear-gradient(135deg, #ff6b6b, #ee5a24);">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-title">Alerta de stock bajo</div>
                            <div class="activity-time">Hace 25 minutos</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Agregar/Editar Producto -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-box"></i>
                    <span id="modalTitle">Agregar Producto</span>
                </div>
                <button class="close-btn" onclick="closeProductModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="productForm">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Nombre del Producto</label>
                        <input type="text" class="form-input" id="productName" placeholder="Ej: Auriculares Bluetooth" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Código</label>
                        <input type="text" class="form-input" id="productSku" placeholder="Se genera automáticamente" readonly>
                        <button type="button" class="auto-generate-btn" onclick="generateSKU()">
                            <i class="fas fa-magic"></i> Generar Automático
                        </button>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Categoría</label>
                        <select class="form-select" id="productCategory" required>
                            <option value="">Seleccionar categoría</option>
                            <option value="auriculares">Auriculares</option>
                            <option value="cargadores">Cargadores</option>
                            <option value="fundas">Fundas</option>
                            <option value="cables">Cables</option>
                            <option value="smartwatch">Smartwatch</option>
                            <option value="otros">Otros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Stock Inicial</label>
                        <input type="number" class="form-input" id="productStock" placeholder="0" min="0" required>
                    </div>
                </div>

                <div class="form-row-three">
                    <div class="form-group">
                        <label class="form-label">Precio de Compra</label>
                        <input type="number" class="form-input" id="productCostPrice" placeholder="0.00" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Flete</label>
                        <input type="number" class="form-input" id="productFreight" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Precio de Venta</label>
                        <input type="number" class="form-input" id="productSalePrice" placeholder="0.00" step="0.01" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Stock Mínimo</label>
                        <input type="number" class="form-input" id="productMinStock" placeholder="5" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Margen de Ganancia (%)</label>
                        <input type="number" class="form-input" id="productMargin" placeholder="Calculado automáticamente" readonly>
                    </div>
                </div>                <div class="form-group">
                    <label class="form-label">Descripción</label>
                    <textarea class="form-textarea" id="productDescription" placeholder="Descripción del producto (opcional)"></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">
                        Cancelar
                    </button>
                    <button type="submit" class="btn">
                        <i class="fas fa-save"></i>
                        Guardar Producto
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Exportación -->
    <div class="modal" id="exportModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-download"></i>
                    <span>Exportar Inventario</span>
                </div>
                <button class="close-btn" onclick="closeExportModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div style="padding: 8px 0;">
                <button class="btn" style="width: 100%; margin-bottom: 12px;" onclick="exportToPDF()">
                    <i class="fas fa-file-pdf"></i>
                    Exportar a PDF
                </button>
                <button class="btn btn-secondary" style="width: 100%; margin-bottom: 12px;" onclick="exportToExcel()">
                    <i class="fas fa-file-excel"></i>
                    Exportar a Excel
                </button>
                <button class="btn btn-secondary" style="width: 100%;" onclick="exportToCSV()">
                    <i class="fas fa-file-csv"></i>
                    Exportar a CSV
                </button>
            </div>
        </div>
    </div>

    <script>
        // Datos de ejemplo para el inventario - ahora con persistencia
        let inventoryData = [];

        // Cargar datos desde localStorage o usar datos por defecto
        function loadInventoryData() {
            // Primero intentar cargar desde la clave del sistema de ventas
            const savedData = localStorage.getItem('aristore_products');
            if (savedData) {
                const productsData = JSON.parse(savedData);
                // Convertir formato de productos de ventas a formato de inventario
                inventoryData = productsData.map(product => ({
                    id: product.id || generateProductId(),
                    name: product.name,
                    sku: product.id,
                    category: product.category?.toLowerCase() || 'otros',
                    stock: product.stock || 0,
                    minStock: 5, // Valor por defecto
                    costPrice: product.price ? product.price * 0.6 : 0, // Estimación
                    freight: 0,
                    salePrice: product.price || 0,
                    description: product.description || '',
                    dateAdded: new Date().toISOString()
                }));
            } else {
                // Si no hay datos de productos, intentar cargar datos antiguos de inventario
                const oldInventoryData = localStorage.getItem('aristore_inventory');
                if (oldInventoryData) {
                    inventoryData = JSON.parse(oldInventoryData);
                } else {
                    // Datos por defecto si no hay datos guardados
                    inventoryData = [
                        {
                            id: 'ARS001',
                            name: "Auriculares Bluetooth Premium",
                            sku: "ARS001",
                            category: "auriculares",
                            stock: 45,
                            minStock: 10,
                            costPrice: 45.00,
                            freight: 5.00,
                            salePrice: 89.99,
                            description: "Auriculares inalámbricos con cancelación de ruido",
                            dateAdded: new Date().toISOString()
                        },
                        {
                            id: 'ARS002',
                            name: "Cargador Inalámbrico Rápido",
                            sku: "ARS002",
                            category: "cargadores",
                            stock: 32,
                            minStock: 15,
                            costPrice: 18.00,
                            freight: 2.00,
                            salePrice: 34.99,
                            description: "Cargador inalámbrico de 15W",
                            dateAdded: new Date().toISOString()
                        },
                        {
                            id: 'ARS003',
                            name: "Funda iPhone Pro Max",
                            sku: "ARS003",
                            category: "fundas",
                            stock: 8,
                            minStock: 20,
                            costPrice: 8.00,
                            freight: 1.00,
                            salePrice: 24.99,
                            description: "Funda protectora transparente",
                            dateAdded: new Date().toISOString()
                        },
                        {
                            id: 'ARS004',
                            name: "Cable USB-C 2m",
                            sku: "ARS004",
                            category: "cables",
                            stock: 67,
                            minStock: 25,
                            costPrice: 12.00,
                            freight: 1.50,
                            salePrice: 12.99,
                            description: "Cable de carga rápida USB-C de alta calidad",
                            dateAdded: new Date().toISOString()
                        },
                        {
                            id: 'ARS005',
                            name: "Smartwatch Fitness",
                            sku: "ARS005",
                            category: "smartwatch",
                            stock: 15,
                            minStock: 8,
                            costPrice: 85.00,
                            freight: 8.00,
                            salePrice: 159.99,
                            description: "Reloj inteligente con monitor de salud y GPS",
                            dateAdded: new Date().toISOString()
                        },
                        {
                            id: 'ARS006',
                            name: "Power Bank 10000mAh",
                            sku: "ARS006",
                            category: "cargadores",
                            stock: 0,
                            minStock: 15,
                            costPrice: 22.00,
                            freight: 3.00,
                            salePrice: 45.99,
                            description: "Batería portátil con carga rápida",
                            dateAdded: new Date().toISOString()
                        }
                    ];
                }
                saveInventoryData();
            }
        }

        // Generar ID único para productos
        function generateProductId() {
            return 'ARS' + String(Date.now()).slice(-6) + String(Math.floor(Math.random() * 100)).padStart(2, '0');
        }

        // Guardar datos en localStorage (sincronizado con sistema de ventas)
        function saveInventoryData() {
            // Convertir formato de inventario a formato compatible con ventas
            const productsForSales = inventoryData.map(item => ({
                id: item.sku || item.id,
                name: item.name,
                price: item.salePrice,
                stock: item.stock,
                category: item.category.charAt(0).toUpperCase() + item.category.slice(1),
                description: item.description
            }));
            
            // Guardar en la clave que usa el sistema de ventas
            localStorage.setItem('aristore_products', JSON.stringify(productsForSales));
            
            // También mantener copia en formato de inventario para compatibilidad
            localStorage.setItem('aristore_inventory', JSON.stringify(inventoryData));
        }

        let currentEditingId = null;

        // Inicializar la página
        document.addEventListener('DOMContentLoaded', function() {
            loadInventoryData();
            updateStats();
            renderInventoryTable();
            setupEventListeners();
            
            // Escuchar cambios en localStorage para sincronización automática
            setupStorageListener();
        });

        // Configurar listener para sincronización automática
        function setupStorageListener() {
            window.addEventListener('storage', function(e) {
                if (e.key === 'aristore_products') {
                    // Recargar datos cuando se actualice desde el sistema de ventas
                    loadInventoryData();
                    updateStats();
                    renderInventoryTable();
                }
            });
            
            // También verificar cambios periódicamente (para cuando ambos módulos están en la misma página)
            setInterval(() => {
                const currentProducts = localStorage.getItem('aristore_products');
                if (currentProducts) {
                    const products = JSON.parse(currentProducts);
                    const needsUpdate = inventoryData.some(item => {
                        const product = products.find(p => p.id === (item.sku || item.id));
                        return product && product.stock !== item.stock;
                    });
                    
                    if (needsUpdate) {
                        loadInventoryData();
                        updateStats();
                        renderInventoryTable();
                        showAlert('Inventario actualizado automáticamente desde el sistema de ventas', 'info');
                    }
                }
            }, 2000); // Verificar cada 2 segundos
        }

        // Configurar event listeners
        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', filterInventory);
            document.getElementById('categoryFilter').addEventListener('change', filterInventory);
            document.getElementById('stockFilter').addEventListener('change', filterInventory);
            document.getElementById('productForm').addEventListener('submit', handleProductSubmit);
            
            // Event listeners para calcular margen automáticamente
            document.getElementById('productCostPrice').addEventListener('input', calculateAndDisplayMargin);
            document.getElementById('productFreight').addEventListener('input', calculateAndDisplayMargin);
            document.getElementById('productSalePrice').addEventListener('input', calculateAndDisplayMargin);
            
            // Event listener para generar código automáticamente cuando se selecciona la categoría
            document.getElementById('productCategory').addEventListener('change', generateSKU);
            document.getElementById('productName').addEventListener('input', generateSKU);
        }

        // Generar código automáticamente
        function generateSKU() {
            const category = document.getElementById('productCategory').value;
            const name = document.getElementById('productName').value;
            
            if (category && name) {
                const categoryPrefix = {
                    'auriculares': 'AUR',
                    'cargadores': 'CAR',
                    'fundas': 'FUN',
                    'cables': 'CAB',
                    'smartwatch': 'SMW',
                    'otros': 'OTR'
                };
                
                const prefix = categoryPrefix[category] || 'PRD';
                const namePrefix = name.substring(0, 3).toUpperCase().replace(/[^A-Z]/g, 'X');
                const timestamp = Date.now().toString().slice(-3);
                const sku = `${prefix}-${namePrefix}-${timestamp}`;
                
                document.getElementById('productSku').value = sku;
            }
        }

        // Calcular margen de ganancia
        function calculateMargin(costPrice, freight, salePrice) {
            const totalCost = parseFloat(costPrice) + parseFloat(freight || 0);
            if (totalCost === 0) return 0;
            return ((parseFloat(salePrice) - totalCost) / totalCost) * 100;
        }

        // Calcular y mostrar margen en el formulario
        function calculateAndDisplayMargin() {
            const costPrice = parseFloat(document.getElementById('productCostPrice').value) || 0;
            const freight = parseFloat(document.getElementById('productFreight').value) || 0;
            const salePrice = parseFloat(document.getElementById('productSalePrice').value) || 0;
            
            const margin = calculateMargin(costPrice, freight, salePrice);
            document.getElementById('productMargin').value = margin.toFixed(2);
        }

        // Actualizar estadísticas
        function updateStats() {
            const totalProducts = inventoryData.length;
            const lowStock = inventoryData.filter(item => item.stock <= item.minStock && item.stock > 0).length;
            const outStock = inventoryData.filter(item => item.stock === 0).length;
            const categories = [...new Set(inventoryData.map(item => item.category))].length;

            document.getElementById('totalProducts').textContent = totalProducts;
            document.getElementById('lowStock').textContent = lowStock;
            document.getElementById('outStock').textContent = outStock;
            document.getElementById('totalCategories').textContent = categories;
            document.getElementById('productCount').textContent = `${totalProducts} productos`;
        }

        // Renderizar tabla de inventario
        function renderInventoryTable(data = inventoryData) {
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = '';

            data.forEach(product => {
                const row = document.createElement('tr');
                
                const stockStatus = getStockStatus(product.stock, product.minStock);
                const categoryName = getCategoryName(product.category);
                const margin = calculateMargin(product.costPrice, product.freight, product.salePrice);

                row.innerHTML = `
                    <td>
                        <div class="product-info">
                            <div class="product-image">
                                ${getCategoryIcon(product.category)}
                            </div>
                            <div class="product-details">
                                <h4>${product.name}</h4>
                                <p>Código: ${product.sku || product.id}</p>
                            </div>
                        </div>
                    </td>
                    <td>${categoryName}</td>
                    <td>${product.stock}</td>
                    <td>$${product.costPrice.toFixed(2)}</td>
                    <td>$${product.salePrice.toFixed(2)}</td>
                    <td style="color: ${margin >= 50 ? '#4ecdc4' : margin >= 25 ? '#f9ca24' : '#ff6b6b'};">
                        ${margin.toFixed(1)}%
                    </td>
                    <td>
                        <span class="stock-badge ${stockStatus.class}">${stockStatus.label}</span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editProduct('${product.id || product.sku}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteProduct('${product.id || product.sku}')" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Obtener estado del stock
        function getStockStatus(stock, minStock) {
            if (stock === 0) {
                return { class: 'out', label: 'Sin Stock' };
            } else if (stock <= minStock) {
                return { class: 'low', label: 'Stock Bajo' };
            } else if (stock <= minStock * 2) {
                return { class: 'medium', label: 'Stock Medio' };
            } else {
                return { class: 'high', label: 'Stock Alto' };
            }
        }

        // Obtener nombre de categoría
        function getCategoryName(category) {
            const categories = {
                'auriculares': 'Auriculares',
                'cargadores': 'Cargadores',
                'fundas': 'Fundas',
                'cables': 'Cables',
                'smartwatch': 'Smartwatch',
                'otros': 'Otros'
            };
            return categories[category] || category;
        }

        // Obtener icono de categoría
        function getCategoryIcon(category) {
            const icons = {
                'auriculares': '<i class="fas fa-headphones"></i>',
                'cargadores': '<i class="fas fa-plug"></i>',
                'fundas': '<i class="fas fa-mobile-alt"></i>',
                'cables': '<i class="fas fa-usb"></i>',
                'smartwatch': '<i class="fas fa-clock"></i>',
                'otros': '<i class="fas fa-box"></i>'
            };
            return icons[category] || '<i class="fas fa-box"></i>';
        }

        // Filtrar inventario
        function filterInventory() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;

            let filteredData = inventoryData.filter(product => {
                const matchesSearch = product.name.toLowerCase().includes(searchTerm) || 
                                    product.sku.toLowerCase().includes(searchTerm);
                
                const matchesCategory = !categoryFilter || product.category === categoryFilter;
                
                let matchesStock = true;
                if (stockFilter) {
                    const stockStatus = getStockStatus(product.stock, product.minStock);
                    matchesStock = stockStatus.class === stockFilter;
                }

                return matchesSearch && matchesCategory && matchesStock;
            });

            renderInventoryTable(filteredData);
            document.getElementById('productCount').textContent = `${filteredData.length} productos`;
        }

        // Abrir modal para agregar producto
        function openAddProductModal() {
            currentEditingId = null;
            document.getElementById('modalTitle').textContent = 'Agregar Producto';
            document.getElementById('productForm').reset();
            
            // Habilitar el campo código para edición manual si es necesario
            document.getElementById('productSku').removeAttribute('readonly');
            document.getElementById('productSku').setAttribute('placeholder', 'Se genera automáticamente');
            
            document.getElementById('productModal').classList.add('show');
        }

        // Cerrar modal
        function closeProductModal() {
            document.getElementById('productModal').classList.remove('show');
            currentEditingId = null;
        }

        // Editar producto
        function editProduct(id) {
            const product = inventoryData.find(p => p.id === id || p.sku === id);
            if (!product) {
                showAlert('Producto no encontrado', 'error');
                return;
            }

            currentEditingId = product.id || product.sku;
            document.getElementById('modalTitle').textContent = 'Editar Producto';
            
            // Llenar todos los campos del formulario
            document.getElementById('productName').value = product.name || '';
            document.getElementById('productSku').value = product.sku || product.id || '';
            document.getElementById('productCategory').value = product.category || '';
            document.getElementById('productCostPrice').value = product.costPrice || 0;
            document.getElementById('productFreight').value = product.freight || 0;
            document.getElementById('productSalePrice').value = product.salePrice || 0;
            document.getElementById('productStock').value = product.stock || 0;
            document.getElementById('productMinStock').value = product.minStock || 0;
            document.getElementById('productDescription').value = product.description || '';
            
            // Calcular y mostrar margen
            calculateAndDisplayMargin();

            // Mostrar modal
            document.getElementById('productModal').classList.add('show');
        }

        // Manejar envío del formulario
        function handleProductSubmit(e) {
            e.preventDefault();

            const productData = {
                name: document.getElementById('productName').value,
                sku: document.getElementById('productSku').value,
                category: document.getElementById('productCategory').value,
                costPrice: parseFloat(document.getElementById('productCostPrice').value),
                freight: parseFloat(document.getElementById('productFreight').value) || 0,
                salePrice: parseFloat(document.getElementById('productSalePrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                minStock: parseInt(document.getElementById('productMinStock').value),
                description: document.getElementById('productDescription').value,
                dateAdded: new Date().toISOString()
            };

            // Validar que el código no esté duplicado
            const isDuplicateSku = inventoryData.some(p => 
                (p.sku === productData.sku || p.id === productData.sku) && (p.id !== currentEditingId && p.sku !== currentEditingId)
            );

            if (isDuplicateSku) {
                showAlert('El código ya existe. Por favor, genera uno nuevo.', 'error');
                return;
            }

            if (currentEditingId) {
                // Editar producto existente
                const index = inventoryData.findIndex(p => p.id === currentEditingId || p.sku === currentEditingId);
                if (index !== -1) {
                    // Mantener el ID original
                    productData.id = inventoryData[index].id || inventoryData[index].sku;
                    inventoryData[index] = { ...inventoryData[index], ...productData };
                    showAlert('Producto actualizado correctamente', 'success');
                }
            } else {
                // Agregar nuevo producto
                const newId = productData.sku || generateProductId();
                inventoryData.push({ ...productData, id: newId, sku: productData.sku || newId });
                showAlert('Producto agregado correctamente', 'success');
            }

            // Guardar en localStorage
            saveInventoryData();
            updateStats();
            renderInventoryTable();
            closeProductModal();
        }

        // Eliminar producto
        function deleteProduct(id) {
            const product = inventoryData.find(p => p.id === id || p.sku === id);
            if (!product) {
                showAlert('Producto no encontrado', 'error');
                return;
            }

            if (confirm(`¿Estás seguro de que deseas eliminar "${product.name}"?\n\nEsta acción no se puede deshacer.`)) {
                inventoryData = inventoryData.filter(p => p.id !== id && p.sku !== id);
                saveInventoryData(); // Guardar cambios
                updateStats();
                renderInventoryTable();
                showAlert('Producto eliminado correctamente', 'success');
            }
        }

        // Mostrar menú de exportación
        function showExportMenu() {
            document.getElementById('exportModal').classList.add('show');
        }

        // Cerrar modal de exportación
        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('show');
        }

        // Exportar a PDF
        function exportToPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configurar el documento
                doc.setFontSize(20);
                doc.text('AriStore - Reporte de Inventario', 20, 20);
                
                doc.setFontSize(12);
                doc.text(`Fecha de generación: ${new Date().toLocaleDateString('es-ES')}`, 20, 30);
                doc.text(`Total de productos: ${inventoryData.length}`, 20, 40);
                
                // Preparar datos para la tabla
                const tableData = inventoryData.map(product => [
                    product.name,
                    product.sku,
                    getCategoryName(product.category),
                    product.stock.toString(),
                    `$${product.costPrice.toFixed(2)}`,
                    `$${product.salePrice.toFixed(2)}`,
                    `${calculateMargin(product.costPrice, product.freight, product.salePrice).toFixed(1)}%`,
                    getStockStatus(product.stock, product.minStock).label
                ]);
                
                // Crear tabla
                doc.autoTable({
                    head: [['Producto', 'Código', 'Categoría', 'Stock', 'P. Compra', 'P. Venta', 'Margen', 'Estado']],
                    body: tableData,
                    startY: 50,
                    styles: {
                        fontSize: 8,
                        cellPadding: 3
                    },
                    headStyles: {
                        fillColor: [102, 126, 234],
                        textColor: 255
                    },
                    columnStyles: {
                        0: { cellWidth: 40 },
                        1: { cellWidth: 25 },
                        2: { cellWidth: 25 },
                        3: { cellWidth: 15 },
                        4: { cellWidth: 20 },
                        5: { cellWidth: 20 },
                        6: { cellWidth: 15 },
                        7: { cellWidth: 20 }
                    }
                });
                
                // Guardar el PDF
                doc.save(`AriStore_Inventario_${new Date().toISOString().split('T')[0]}.pdf`);
                
                closeExportModal();
                showAlert('Reporte PDF generado correctamente', 'success');
            } catch (error) {
                console.error('Error al generar PDF:', error);
                showAlert('Error al generar el PDF. Verifica que las librerías estén cargadas.', 'error');
            }
        }

        // Exportar a Excel
        function exportToExcel() {
            try {
                // Preparar datos para Excel
                const excelData = inventoryData.map(product => ({
                    'Producto': product.name,
                    'Código': product.sku,
                    'Categoría': getCategoryName(product.category),
                    'Stock': product.stock,
                    'Stock Mínimo': product.minStock,
                    'Precio Compra': product.costPrice,
                    'Flete': product.freight || 0,
                    'Precio Venta': product.salePrice,
                    'Margen (%)': calculateMargin(product.costPrice, product.freight, product.salePrice).toFixed(2),
                    'Estado': getStockStatus(product.stock, product.minStock).label,
                    'Descripción': product.description || '',
                    'Fecha Agregado': product.dateAdded ? new Date(product.dateAdded).toLocaleDateString('es-ES') : ''
                }));
                
                // Crear libro de trabajo
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Ajustar ancho de columnas
                const colWidths = [
                    { wch: 30 }, // Producto
                    { wch: 15 }, // Código
                    { wch: 15 }, // Categoría
                    { wch: 10 }, // Stock
                    { wch: 12 }, // Stock Mínimo
                    { wch: 12 }, // Precio Compra
                    { wch: 10 }, // Flete
                    { wch: 12 }, // Precio Venta
                    { wch: 12 }, // Margen
                    { wch: 15 }, // Estado
                    { wch: 30 }, // Descripción
                    { wch: 15 }  // Fecha
                ];
                ws['!cols'] = colWidths;
                
                // Agregar hoja al libro
                XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
                
                // Descargar archivo
                XLSX.writeFile(wb, `AriStore_Inventario_${new Date().toISOString().split('T')[0]}.xlsx`);
                
                closeExportModal();
                showAlert('Archivo Excel generado correctamente', 'success');
            } catch (error) {
                console.error('Error al generar Excel:', error);
                showAlert('Error al generar el archivo Excel. Verifica que las librerías estén cargadas.', 'error');
            }
        }

        // Exportar a CSV
        function exportToCSV() {
            try {
                // Preparar datos CSV
                const csvData = inventoryData.map(product => ({
                    'Producto': product.name,
                    'Código': product.sku,
                    'Categoría': getCategoryName(product.category),
                    'Stock': product.stock,
                    'Stock Mínimo': product.minStock,
                    'Precio Compra': product.costPrice,
                    'Flete': product.freight || 0,
                    'Precio Venta': product.salePrice,
                    'Margen (%)': calculateMargin(product.costPrice, product.freight, product.salePrice).toFixed(2),
                    'Estado': getStockStatus(product.stock, product.minStock).label,
                    'Descripción': product.description || '',
                    'Fecha Agregado': product.dateAdded ? new Date(product.dateAdded).toLocaleDateString('es-ES') : ''
                }));
                
                // Convertir a CSV
                const ws = XLSX.utils.json_to_sheet(csvData);
                const csv = XLSX.utils.sheet_to_csv(ws);
                
                // Crear y descargar archivo
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `AriStore_Inventario_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                closeExportModal();
                showAlert('Archivo CSV generado correctamente', 'success');
            } catch (error) {
                console.error('Error al generar CSV:', error);
                showAlert('Error al generar el archivo CSV', 'error');
            }
        }

        // Actualización masiva
        function bulkUpdate() {
            showAlert('Función de actualización masiva disponible próximamente', 'info');
        }

        // Alertas de stock bajo
        function lowStockAlert() {
            const lowStockProducts = inventoryData.filter(item => item.stock <= item.minStock);
            if (lowStockProducts.length > 0) {
                let message = `Productos con stock bajo:\n`;
                lowStockProducts.forEach(product => {
                    message += `• ${product.name}: ${product.stock} unidades\n`;
                });
                alert(message);
            } else {
                showAlert('No hay productos con stock bajo', 'success');
            }
        }

        // Generar reporte
        function generateReport() {
            // Crear reporte detallado en una nueva ventana
            const reportWindow = window.open('', 'ReporteInventario', 'width=800,height=600');
            
            const reportHTML = `
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>AriStore - Reporte de Inventario</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #667eea; padding-bottom: 20px; }
                        .logo { font-size: 2rem; font-weight: bold; color: #667eea; }
                        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
                        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 8px; text-align: center; border-left: 4px solid #667eea; }
                        .stat-number { font-size: 1.8rem; font-weight: bold; color: #667eea; }
                        .stat-label { color: #666; font-size: 0.9rem; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background-color: #667eea; color: white; }
                        tr:nth-child(even) { background-color: #f2f2f2; }
                        .stock-high { color: #28a745; font-weight: bold; }
                        .stock-medium { color: #ffc107; font-weight: bold; }
                        .stock-low { color: #fd7e14; font-weight: bold; }
                        .stock-out { color: #dc3545; font-weight: bold; }
                        .footer { margin-top: 30px; text-align: center; color: #666; font-size: 0.9rem; }
                        @media print { body { margin: 0; } }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <div class="logo">AriStore</div>
                        <h2>Reporte de Inventario</h2>
                        <p>Generado el: ${new Date().toLocaleDateString('es-ES', { 
                            year: 'numeric', month: 'long', day: 'numeric',
                            hour: '2-digit', minute: '2-digit'
                        })}</p>
                    </div>
                    
                    <div class="stats">
                        <div class="stat-card">
                            <div class="stat-number">${inventoryData.length}</div>
                            <div class="stat-label">Total Productos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${inventoryData.filter(item => item.stock <= item.minStock && item.stock > 0).length}</div>
                            <div class="stat-label">Stock Bajo</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${inventoryData.filter(item => item.stock === 0).length}</div>
                            <div class="stat-label">Sin Stock</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${[...new Set(inventoryData.map(item => item.category))].length}</div>
                            <div class="stat-label">Categorías</div>
                        </div>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Código</th>
                                <th>Categoría</th>
                                <th>Stock</th>
                                <th>P. Compra</th>
                                <th>P. Venta</th>
                                <th>Margen</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${inventoryData.map(product => {
                                const stockStatus = getStockStatus(product.stock, product.minStock);
                                const margin = calculateMargin(product.costPrice, product.freight, product.salePrice);
                                return `
                                    <tr>
                                        <td>${product.name}</td>
                                        <td>${product.sku}</td>
                                        <td>${getCategoryName(product.category)}</td>
                                        <td>${product.stock}</td>
                                        <td>$${product.costPrice.toFixed(2)}</td>
                                        <td>$${product.salePrice.toFixed(2)}</td>
                                        <td>${margin.toFixed(1)}%</td>
                                        <td class="stock-${stockStatus.class}">${stockStatus.label}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <p>AriStore - Sistema de Gestión de Inventario</p>
                        <button onclick="window.print()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 10px;">
                            Imprimir Reporte
                        </button>
                    </div>
                </body>
                </html>
            `;
            
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
            
            showAlert('Reporte generado en nueva ventana', 'success');
        }

        // Mostrar alertas
        function showAlert(message, type = 'info') {
            // Crear elemento de alerta
            const alert = document.createElement('div');
            alert.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                background: rgba(28, 28, 38, 0.95);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                color: #ffffff;
                z-index: 1001;
                backdrop-filter: blur(20px);
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;
            
            // Color según tipo
            const colors = {
                success: '#4ecdc4',
                error: '#ff6b6b',
                info: '#667eea'
            };
            alert.style.borderLeftColor = colors[type];
            alert.style.borderLeftWidth = '4px';
            
            alert.textContent = message;
            document.body.appendChild(alert);
            
            // Animar entrada
            setTimeout(() => {
                alert.style.transform = 'translateX(0)';
            }, 100);
            
            // Remover después de 3 segundos
            setTimeout(() => {
                alert.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    document.body.removeChild(alert);
                }, 300);
            }, 3000);
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('productModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeProductModal();
            }
        });

        // Cerrar modal de exportación al hacer clic fuera
        document.getElementById('exportModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeExportModal();
            }
        });
    </script>
</body>
</html>
