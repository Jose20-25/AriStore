<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ventas - AriStore ERP</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #2d3748;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar (compacto) */
        .sidebar { width: 280px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-right: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1); position: fixed; height: 100vh; left: 0; top: 0; z-index: 1000; overflow-y: auto; }
        .sidebar-header { padding: 24px 20px; border-bottom: 1px solid rgba(0, 0, 0, 0.1); background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); }
        .sidebar-logo { display: flex; align-items: center; text-decoration: none; color: white; font-weight: 700; font-size: 20px; }
        .sidebar-logo img { width: 40px; height: 40px; margin-right: 12px; border-radius: 8px; }
        .sidebar-nav { padding: 20px 0; }
        .nav-section { margin-bottom: 32px; }
        .nav-section-title { padding: 0 20px 12px; font-size: 12px; font-weight: 600; text-transform: uppercase; color: #64748b; letter-spacing: 0.5px; }
        .nav-item { display: flex; align-items: center; padding: 12px 20px; text-decoration: none; color: #475569; font-weight: 500; transition: all 0.3s ease; position: relative; }
        .nav-item:hover { background: rgba(102, 126, 234, 0.1); color: #4f46e5; transform: translateX(4px); }
        .nav-item.active { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); color: white; font-weight: 600; }
        .nav-item.active::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: #fbbf24; border-radius: 0 4px 4px 0; }
        .nav-item i { width: 20px; margin-right: 12px; font-size: 16px; }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            background: #f8fafc;
        }

        /* Header */
        .header {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-title h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
            transform: translateY(-2px);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-card-title {
            font-size: 0.9rem;
            color: #718096;
            font-weight: 500;
        }

        .stat-card-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .stat-card-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .stat-card-trend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .trend-up {
            color: #38a169;
        }

        .trend-down {
            color: #e53e3e;
        }

        /* Sales Form */
        .sales-section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        .section-header {
            padding: 2rem 2rem 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .section-subtitle {
            color: #718096;
            font-size: 0.95rem;
        }

        .section-content {
            padding: 2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Product Selection */
        .product-search {
            position: relative;
        }

        .product-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e2e8f0;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
        }

        .product-item {
            padding: 1rem;
            cursor: pointer;
            border-bottom: 1px solid #f7fafc;
            transition: background 0.2s ease;
        }

        .product-item:hover {
            background: #f7fafc;
        }

        .product-item:last-child {
            border-bottom: none;
        }

        /* Cart Items */
        .cart-section {
            margin-top: 2rem;
        }

        .cart-items {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            min-height: 200px;
        }

        .cart-item {
            display: flex;
            justify-content: between;
            align-items: center;
            padding: 1rem;
            background: white;
            border-radius: 10px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .cart-item:last-child {
            margin-bottom: 0;
        }

        .cart-item-info {
            flex: 1;
        }

        .cart-item-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.25rem;
        }

        .cart-item-code {
            font-size: 0.85rem;
            color: #718096;
        }

        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quantity-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 6px;
            background: #e2e8f0;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity-btn:hover {
            background: #cbd5e0;
        }

        .quantity-input {
            width: 60px;
            text-align: center;
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }

        .item-price {
            font-weight: 600;
            color: #16a34a;
            min-width: 80px;
            text-align: right;
        }

        .remove-btn {
            background: #fed7d7;
            color: #e53e3e;
            border: none;
            border-radius: 6px;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .remove-btn:hover {
            background: #feb2b2;
        }

        /* Totals */
        .totals-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
        }

        .totals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .total-item {
            text-align: center;
        }

        .total-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .total-value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .final-total {
            text-align: center;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.3);
        }

        .final-total .total-label {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .final-total .total-value {
            font-size: 3rem;
            font-weight: 800;
        }

        /* Empty Cart */
        .empty-cart {
            text-align: center;
            padding: 3rem 2rem;
            color: #718096;
        }

        .empty-cart i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-cart h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: #4a5568;
        }

        .empty-cart p {
            font-size: 1rem;
            line-height: 1.6;
        }

        /* Sales History */
        .sales-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .sales-table th,
        .sales-table td {
            padding: 1rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .sales-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .sales-table tbody tr:hover {
            background: #f8fafc;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }

            .main-content {
                margin-left: 0;
            }

            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 1% auto;
            padding: 0;
            width: 95%;
            max-width: 1400px;
            max-height: 95vh;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            animation: slideIn 0.4s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 32px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }

        .modal-title {
            font-size: 28px;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            z-index: 1;
        }

        .modal-close {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            padding: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 40px;
            background: #fafbfc;
            max-height: calc(95vh - 140px);
            overflow-y: auto;
        }

        .modal-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 40px;
            height: 100%;
        }

        .modal-left {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .modal-right {
            background: white;
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            position: sticky;
            top: 0;
            height: fit-content;
        }

        .form-section {
            margin-bottom: 32px;
        }

        .form-section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-section-title i {
            color: #667eea;
        }

        .form-grid-modal {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .form-group-modal {
            margin-bottom: 0;
        }

        .form-label-modal {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .form-input-modal, .form-select-modal {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input-modal:focus, .form-select-modal:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .products-table-container {
            background: #f8fafc;
            border-radius: 12px;
            padding: 24px;
            border: 2px solid #e5e7eb;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .products-table th {
            background: linear-gradient(135deg, #f8fafc 0%, #e5e7eb 100%);
            padding: 16px 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #e5e7eb;
        }

        .products-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: middle;
        }

        .products-table tbody tr:hover {
            background: #f8fafc;
        }

        .quantity-controls-modal {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .quantity-btn-modal {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .quantity-btn-modal:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }

        .quantity-input-modal {
            width: 50px;
            text-align: center;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 4px;
            font-weight: 600;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            padding: 24px;
            color: white;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }

        .summary-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 20px;
            font-weight: 700;
            padding-top: 16px;
            border-top: 2px solid rgba(255, 255, 255, 0.3);
            position: relative;
            z-index: 1;
        }

        .btn-process-sale {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        .btn-process-sale:enabled:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .btn-process-sale:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: #9ca3af;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            color: #d1d5db;
        }

        @media (max-width: 1024px) {
            .modal-content {
                width: 98%;
                margin: 1% auto;
            }

            .modal-grid {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .modal-right {
                position: static;
            }

            .modal-header {
                padding: 24px 32px;
            }

            .modal-body {
                padding: 24px;
            }

            .modal-left, .modal-right {
                padding: 24px;
            }
        }

        .products-grid-container {
            background: #f8fafc;
            border-radius: 12px;
            padding: 24px;
            border: 2px solid #e5e7eb;
            max-height: 400px;
            overflow-y: auto;
        }

        .productos-disponibles {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .producto-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .producto-card:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .producto-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f3f4f6;
        }

        .producto-card.disabled:hover {
            transform: none;
            box-shadow: none;
            border-color: #e5e7eb;
        }

        .producto-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .producto-info h4 {
            font-size: 14px;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 4px 0;
            line-height: 1.3;
        }

        .producto-codigo {
            font-size: 12px;
            color: #6b7280;
            font-weight: 500;
        }

        .producto-stock {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .stock-alto {
            background: #d1fae5;
            color: #059669;
        }

        .stock-medio {
            background: #fef3c7;
            color: #d97706;
        }

        .stock-bajo {
            background: #fee2e2;
            color: #dc2626;
        }

        .stock-agotado {
            background: #f3f4f6;
            color: #6b7280;
        }

        .producto-precio {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #f3f4f6;
        }

        .precio-valor {
            font-size: 16px;
            font-weight: 700;
            color: #059669;
        }

        .btn-agregar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-agregar:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-agregar:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .productos-grid-nueva {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            padding: 20px 0;
        }

        .producto-card-simple {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 120px;
        }

        .producto-card-simple:hover {
            transform: translateY(-2px);
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .producto-card-simple.ya-agregado {
            background: #f8fafc;
            border-color: #10b981;
            cursor: not-allowed;
            opacity: 0.8;
        }

        .producto-card-simple.ya-agregado:hover {
            transform: none;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .producto-content-simple {
            flex: 1;
            margin-bottom: 16px;
        }

        .producto-nombre-simple {
            font-size: 16px;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 12px 0;
            line-height: 1.4;
        }

        .producto-stock-simple {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .producto-accion-simple {
            display: flex;
            justify-content: center;
        }

        .btn-agregar-simple {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            width: 100%;
            justify-content: center;
        }

        .btn-agregar-simple:hover:not(.agregado) {
            transform: scale(1.02);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .btn-agregar-simple.agregado {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        @media (max-width: 768px) {
            .productos-grid-nueva {
                grid-template-columns: 1fr;
                padding: 16px 0;
            }
            
            .producto-card-simple {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="index.html" class="sidebar-logo">
                    <img src="logos/aristore.png" alt="AriStore Logo">
                    <span>AriStore ERP</span>
                </a>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-section-title">Principal</div>
                    <a href="index.html" class="nav-item"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
                    <a href="analytics.html" class="nav-item"><i class="fas fa-chart-line"></i><span>An√°lisis</span></a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Gesti√≥n</div>
                    <a href="ventas.html" class="nav-item active"><i class="fas fa-shopping-cart"></i><span>Ventas</span></a>
                    <a href="inventario.html" class="nav-item"><i class="fas fa-boxes"></i><span>Inventario</span></a>
                    <a href="clientes.html" class="nav-item"><i class="fas fa-users"></i><span>Clientes</span></a>
                    <a href="proveedores.html" class="nav-item"><i class="fas fa-truck"></i><span>Proveedores</span></a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Finanzas</div>
                    <a href="contabilidad.html" class="nav-item"><i class="fas fa-calculator"></i><span>Contabilidad</span></a>
                    <a href="facturacion.html" class="nav-item"><i class="fas fa-file-invoice"></i><span>Facturaci√≥n</span></a>
                    <a href="reportes.html" class="nav-item"><i class="fas fa-chart-pie"></i><span>Reportes</span></a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">RRHH</div>
                    <a href="empleados.html" class="nav-item"><i class="fas fa-user-tie"></i><span>Empleados</span></a>
                    <a href="nomina.html" class="nav-item"><i class="fas fa-money-check-alt"></i><span>N√≥mina</span></a>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Sistema</div>
                    <a href="configuracion.html" class="nav-item"><i class="fas fa-cog"></i><span>Configuraci√≥n</span></a>
                    <a href="usuarios.html" class="nav-item"><i class="fas fa-users-cog"></i><span>Usuarios</span></a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="header-title">
                    <i class="fas fa-shopping-cart" style="font-size: 2rem; color: #667eea;"></i>
                    <h1>Gesti√≥n de Ventas</h1>
                </div>
                <div class="header-actions">
                    <a href="#" class="btn btn-secondary" onclick="exportSales()">
                        <i class="fas fa-download"></i>
                        Exportar Ventas
                    </a>
                    <a href="#" class="btn btn-primary" onclick="generateSalesReport()">
                        <i class="fas fa-chart-line"></i>
                        Reporte de Ventas
                    </a>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-title">Ventas del D√≠a</div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>
                    <div class="stat-card-value" id="dailySales">$0.00</div>
                    <div class="stat-card-trend trend-up">
                        <i class="fas fa-arrow-up"></i>
                        <span>+15% vs ayer</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-title">Ventas del Mes</div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                    </div>
                    <div class="stat-card-value" id="monthlySales">$0.00</div>
                    <div class="stat-card-trend trend-up">
                        <i class="fas fa-arrow-up"></i>
                        <span>+23% vs mes anterior</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-title">√ìrdenes Hoy</div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                            <i class="fas fa-receipt"></i>
                        </div>
                    </div>
                    <div class="stat-card-value" id="dailyOrders">0</div>
                    <div class="stat-card-trend trend-up">
                        <i class="fas fa-arrow-up"></i>
                        <span>+5 vs ayer</span>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-card-header">
                        <div class="stat-card-title">Ticket Promedio</div>
                        <div class="stat-card-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                    <div class="stat-card-value" id="averageTicket">$0.00</div>
                    <div class="stat-card-trend trend-up">
                        <i class="fas fa-arrow-up"></i>
                        <span>+8% vs promedio</span>
                    </div>
                </div>
            </div>

            <!-- Bot√≥n Nueva Venta -->
            <div class="sales-section">
                <div class="section-header">
                    <h2 class="section-title">Gesti√≥n de Ventas</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="abrirModalVenta()">
                            <i class="fas fa-plus"></i> Nueva Venta
                        </button>
                        <button class="btn btn-secondary" onclick="pruebaCompleta()" style="background: #ef4444;">
                            <i class="fas fa-bug"></i> Prueba Sistema
                        </button>
                    </div>
                </div>
            </div>

            <!-- Historial de Ventas -->
            <div class="sales-section">
                <div class="section-header">
                    <h2 class="section-title">Historial de Ventas</h2>
                    <p class="section-subtitle">√öltimas ventas realizadas en el sistema</p>
                </div>
                <div class="section-content">
                    <div style="overflow-x: auto;">
                        <table class="sales-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>N¬∞ Venta</th>
                                    <th>Cliente</th>
                                    <th>Productos</th>
                                    <th>Total</th>
                                    <th>M√©todo Pago</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="salesHistory">
                                <!-- Las ventas se cargar√°n din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Sistema de gesti√≥n de ventas
        const PRODUCTS_STORAGE_KEY = 'aristore_products';
        const SALES_STORAGE_KEY = 'aristore_sales';
        const SALE_NUMBER_KEY = 'aristore_sale_number';

        let cart = [];
        let products = []; // Variable global para productos
        let saleCounter = parseInt(localStorage.getItem(SALE_NUMBER_KEY)) || 1001;

        // Cargar productos desde localStorage
        function loadProducts() {
            const storedProducts = localStorage.getItem(PRODUCTS_STORAGE_KEY);
            const loadedProducts = storedProducts ? JSON.parse(storedProducts) : [];
            
            // Si no hay productos, crear algunos de ejemplo para testing
            if (loadedProducts.length === 0) {
                console.log('‚ö†Ô∏è No hay productos en localStorage, creando productos de ejemplo...');
                const productosEjemplo = [
                    {
                        id: 1,
                        codigo: 'PROD001',
                        nombre: 'Laptop HP',
                        salePrice: 15000,
                        stock: 10,
                        categoria: 'Electr√≥nicos'
                    },
                    {
                        id: 2,
                        codigo: 'PROD002',
                        nombre: 'Mouse Inal√°mbrico',
                        salePrice: 350,
                        stock: 25,
                        categoria: 'Accesorios'
                    },
                    {
                        id: 3,
                        codigo: 'PROD003',
                        nombre: 'Teclado Mec√°nico',
                        salePrice: 1200,
                        stock: 8,
                        categoria: 'Accesorios'
                    }
                ];
                
                localStorage.setItem(PRODUCTS_STORAGE_KEY, JSON.stringify(productosEjemplo));
                return productosEjemplo;
            }
            
            return loadedProducts;
        }

        // Cargar ventas desde localStorage con recuperaci√≥n de backup
        function loadSales() {
            try {
                console.log('üîç Cargando ventas con clave:', SALES_STORAGE_KEY);
                
                let storedSales = localStorage.getItem(SALES_STORAGE_KEY);
                console.log('ÔøΩ Datos principales encontrados:', !!storedSales);
                
                // Si no hay datos principales, intentar recuperar de backup
                if (!storedSales) {
                    console.log('‚ö†Ô∏è No se encontraron datos principales, buscando backups...');
                    const allKeys = Object.keys(localStorage);
                    const backupKeys = allKeys.filter(key => key.startsWith(`${SALES_STORAGE_KEY}_backup_`))
                        .sort().reverse(); // M√°s reciente primero
                    
                    if (backupKeys.length > 0) {
                        console.log('ÔøΩ Encontrados', backupKeys.length, 'backups, usando el m√°s reciente:', backupKeys[0]);
                        storedSales = localStorage.getItem(backupKeys[0]);
                        
                        // Restaurar desde backup
                        if (storedSales) {
                            localStorage.setItem(SALES_STORAGE_KEY, storedSales);
                            console.log('‚úÖ Datos restaurados desde backup');
                        }
                    }
                }
                
                if (!storedSales) {
                    console.log('üìã No hay ventas guardadas ni backups, retornando array vac√≠o');
                    return [];
                }
                
                const parsed = JSON.parse(storedSales);
                console.log('‚úÖ Ventas cargadas exitosamente:', parsed.length);
                
                // Validar estructura de datos
                const validSales = parsed.filter(sale => {
                    return sale && 
                           (sale.id || sale.fecha) && 
                           (sale.total !== undefined) &&
                           (sale.productos || sale.items);
                });
                
                if (validSales.length !== parsed.length) {
                    console.log('‚ö†Ô∏è Se encontraron', parsed.length - validSales.length, 'ventas con datos inv√°lidos');
                }
                
                return validSales;
                
            } catch (error) {
                console.error('‚ùå Error al cargar ventas:', error);
                
                // Intentar recuperar de backups en caso de error
                try {
                    const allKeys = Object.keys(localStorage);
                    const backupKeys = allKeys.filter(key => key.startsWith(`${SALES_STORAGE_KEY}_backup_`))
                        .sort().reverse();
                    
                    if (backupKeys.length > 0) {
                        console.log('üîÑ Intentando recuperar desde backup tras error...');
                        const backupData = localStorage.getItem(backupKeys[0]);
                        if (backupData) {
                            const backupSales = JSON.parse(backupData);
                            localStorage.setItem(SALES_STORAGE_KEY, backupData);
                            console.log('‚úÖ Recuperado desde backup:', backupSales.length, 'ventas');
                            return backupSales;
                        }
                    }
                } catch (backupError) {
                    console.error('‚ùå Tambi√©n fall√≥ la recuperaci√≥n de backup:', backupError);
                }
                
                return [];
            }
        }

        // Guardar venta en localStorage - VERSI√ìN SIMPLIFICADA PARA SOLUCIONAR PERSISTENCIA
        function saveSale(sale) {
            console.log('üíæ GUARDANDO VENTA (versi√≥n simplificada)');
            console.log('üìù Sale object:', sale);
            
            try {
                // 1. Obtener ventas existentes de forma simple
                let sales = [];
                const existingData = localStorage.getItem(SALES_STORAGE_KEY);
                
                if (existingData) {
                    try {
                        sales = JSON.parse(existingData);
                        if (!Array.isArray(sales)) {
                            console.warn('‚ö†Ô∏è Datos existentes no son array, reiniciando');
                            sales = [];
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Error parseando datos existentes:', e);
                        sales = [];
                    }
                }
                
                console.log('üì¶ Ventas existentes:', sales.length);
                
                // 2. Agregar nueva venta al inicio
                sales.unshift(sale);
                console.log('‚ûï Venta agregada, total:', sales.length);
                
                // 3. Guardar de forma directa
                const dataToSave = JSON.stringify(sales);
                localStorage.setItem(SALES_STORAGE_KEY, dataToSave);
                console.log('üíΩ Datos guardados en localStorage');
                
                // 4. Verificar que se guard√≥
                const saved = localStorage.getItem(SALES_STORAGE_KEY);
                if (saved) {
                    const verification = JSON.parse(saved);
                    console.log('‚úÖ VERIFICACI√ìN EXITOSA:', verification.length, 'ventas guardadas');
                    console.log('üéØ Primera venta verificada:', verification[0]?.numeroVenta);
                    
                    // Crear backup simple
                    localStorage.setItem(`${SALES_STORAGE_KEY}_simple_backup`, dataToSave);
                    console.log('üîê Backup simple creado');
                    
                    return true;
                } else {
                    console.error('‚ùå FALLO: No se pudo verificar el guardado');
                    return false;
                }
                
            } catch (error) {
                console.error('‚ùå ERROR CR√çTICO en saveSale:', error);
                
                // Intento de emergencia con clave diferente
                try {
                    localStorage.setItem(`emergency_sales_${Date.now()}`, JSON.stringify([sale]));
                    console.log('üÜò Guardado de emergencia realizado');
                } catch (emergencyError) {
                    console.error('‚ùå Fall√≥ incluso el guardado de emergencia:', emergencyError);
                }
                
                return false;
            }
        }

        // B√∫squeda de productos
        function setupProductSearch() {
            const searchInput = document.getElementById('productSearch');
            const productList = document.getElementById('productList');

            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                
                if (searchTerm.length < 2) {
                    productList.style.display = 'none';
                    return;
                }

                const products = loadProducts();
                const filteredProducts = products.filter(product => 
                    product.name.toLowerCase().includes(searchTerm) ||
                    product.code.toLowerCase().includes(searchTerm) ||
                    product.categoryName.toLowerCase().includes(searchTerm)
                );

                if (filteredProducts.length > 0) {
                    productList.innerHTML = '';
                    filteredProducts.forEach(product => {
                        const item = document.createElement('div');
                        item.className = 'product-item';
                        item.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; color: #2d3748;">${product.name}</div>
                                    <div style="font-size: 0.85rem; color: #718096;">${product.code} - ${product.categoryName}</div>
                                    <div style="font-size: 0.85rem; color: #718096;">Stock: ${product.stock}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 600; color: #16a34a;">$${product.salePrice.toFixed(2)}</div>
                                </div>
                            </div>
                        `;
                        item.addEventListener('click', () => addToCart(product));
                        productList.appendChild(item);
                    });
                    productList.style.display = 'block';
                } else {
                    productList.style.display = 'none';
                }
            });

            // Ocultar lista al hacer clic fuera
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !productList.contains(e.target)) {
                    productList.style.display = 'none';
                }
            });
        }

        // Agregar producto al carrito
        function addToCart(product) {
            if (product.stock <= 0) {
                showNotification('Este producto no tiene stock disponible', 'error');
                return;
            }

            const existingItem = cart.find(item => item.id === product.id);
            
            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity += 1;
                    showNotification(`Cantidad de ${product.name} aumentada`, 'success');
                } else {
                    showNotification('No hay m√°s stock disponible', 'error');
                    return;
                }
            } else {
                cart.push({
                    ...product,
                    quantity: 1
                });
                showNotification(`${product.name} agregado al carrito`, 'success');
            }

            renderCart();
            document.getElementById('productSearch').value = '';
            document.getElementById('productList').style.display = 'none';
        }

        // Renderizar carrito
        function renderCart() {
            const cartContainer = document.getElementById('cartItems');
            const totalsSection = document.getElementById('totalsSection');

            if (cart.length === 0) {
                cartContainer.innerHTML = `
                    <div class="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>Carrito Vac√≠o</h3>
                        <p>Busca y selecciona productos para agregarlos al carrito</p>
                    </div>
                `;
                totalsSection.style.display = 'none';
                return;
            }

            cartContainer.innerHTML = '';
            cart.forEach(item => {
                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item';
                cartItem.innerHTML = `
                    <div class="cart-item-info">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-code">${item.code} - Stock disponible: ${item.stock}</div>
                    </div>
                    <div class="cart-item-controls">
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="updateQuantity(${item.id}, -1)">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" class="quantity-input" value="${item.quantity}" 
                                   onchange="setQuantity(${item.id}, this.value)" min="1" max="${item.stock}">
                            <button class="quantity-btn" onclick="updateQuantity(${item.id}, 1)">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="item-price">$${(item.salePrice * item.quantity).toFixed(2)}</div>
                        <button class="remove-btn" onclick="removeFromCart(${item.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                cartContainer.appendChild(cartItem);
            });

            updateTotals();
            totalsSection.style.display = 'block';
        }

        // Actualizar cantidad
        function updateQuantity(productId, change) {
            const item = cart.find(item => item.id === productId);
            if (!item) return;

            const newQuantity = item.quantity + change;
            
            if (newQuantity <= 0) {
                removeFromCart(productId);
                return;
            }

            if (newQuantity > item.stock) {
                showNotification('No hay m√°s stock disponible', 'error');
                return;
            }

            item.quantity = newQuantity;
            renderCart();
        }

        // Establecer cantidad espec√≠fica
        function setQuantity(productId, newQuantity) {
            const item = cart.find(item => item.id === productId);
            if (!item) return;

            newQuantity = parseInt(newQuantity);
            
            if (newQuantity <= 0) {
                removeFromCart(productId);
                return;
            }

            if (newQuantity > item.stock) {
                showNotification('Cantidad mayor al stock disponible', 'error');
                renderCart(); // Re-renderizar para restaurar valor anterior
                return;
            }

            item.quantity = newQuantity;
            renderCart();
        }

        // Remover del carrito
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            renderCart();
            showNotification('Producto removido del carrito', 'success');
        }

        // Actualizar totales
        function updateTotals() {
            const subtotal = cart.reduce((sum, item) => sum + (item.salePrice * item.quantity), 0);
            const taxRate = 0.12; // 12% de impuestos
            const discountRate = 0; // Sin descuento por defecto
            
            const discount = subtotal * discountRate;
            const taxes = (subtotal - discount) * taxRate;
            const total = subtotal - discount + taxes;

            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('discount').textContent = `$${discount.toFixed(2)}`;
            document.getElementById('taxes').textContent = `$${taxes.toFixed(2)}`;
            document.getElementById('finalTotal').textContent = `$${total.toFixed(2)}`;
        }

        // Procesar venta
        function processSale() {
            if (cart.length === 0) {
                showNotification('El carrito est√° vac√≠o', 'error');
                return;
            }

            const customer = document.getElementById('customerSelect').value;
            const paymentMethod = document.getElementById('paymentMethod').value;

            if (!customer || !paymentMethod) {
                showNotification('Por favor selecciona cliente y m√©todo de pago', 'error');
                return;
            }

            // Calcular totales
            const subtotal = cart.reduce((sum, item) => sum + (item.salePrice * item.quantity), 0);
            const taxes = subtotal * 0.12;
            const total = subtotal + taxes;

            // Crear venta
            const sale = {
                id: Date.now(),
                saleNumber: saleCounter++,
                date: new Date().toISOString(),
                customer: customer,
                paymentMethod: paymentMethod,
                items: [...cart],
                subtotal: subtotal,
                taxes: taxes,
                total: total,
                status: 'completada'
            };

            // Actualizar stock de productos
            updateProductStock();

            // Guardar venta
            saveSale(sale);

            // Limpiar carrito
            cart = [];
            renderCart();

            // Limpiar formulario
            document.getElementById('customerSelect').value = '';
            document.getElementById('paymentMethod').value = '';

            // Actualizar estad√≠sticas y historial
            updateStats();
            renderSalesHistory();

            showNotification(`Venta #${sale.saleNumber} procesada exitosamente`, 'success');
        }

        // Actualizar stock de productos
        function updateProductStock() {
            let products = loadProducts();
            
            cart.forEach(cartItem => {
                const productIndex = products.findIndex(p => p.id === cartItem.id);
                if (productIndex !== -1) {
                    products[productIndex].stock -= cartItem.quantity;
                }
            });

            localStorage.setItem(PRODUCTS_STORAGE_KEY, JSON.stringify(products));
        }

        // Renderizar historial de ventas
        function renderSalesHistory() {
            console.log('üìã Iniciando renderSalesHistory...');
            const salesHistory = document.getElementById('salesHistory');
            
            if (!salesHistory) {
                console.error('‚ùå Elemento salesHistory no encontrado');
                console.log('üîç Elementos disponibles con ID relacionado:', 
                    Array.from(document.querySelectorAll('[id*="sales"], [id*="history"]')).map(el => el.id));
                return;
            }

            console.log('‚úÖ Elemento salesHistory encontrado:', salesHistory.tagName);

            const sales = loadSales();
            console.log('üì¶ Sales cargadas en renderSalesHistory:', sales.length);
            
            if (sales.length > 0) {
                console.log('üìù Detalle de las primeras 3 ventas:');
                sales.slice(0, 3).forEach((sale, index) => {
                    console.log(`   Venta ${index + 1}:`, {
                        id: sale.id,
                        numeroVenta: sale.numeroVenta,
                        fecha: sale.fecha,
                        total: sale.total,
                        clienteNombre: sale.clienteNombre
                    });
                });
            } else {
                console.log('‚ö†Ô∏è No hay ventas para mostrar');
            }

            if (sales.length === 0) {
                console.log('üö´ Mostrando mensaje de "no hay ventas"');
                salesHistory.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">
                            <div>
                                <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; color: #d1d5db;"></i>
                                <p style="font-size: 18px; font-weight: 500; margin-bottom: 8px;">No hay ventas registradas</p>
                                <p style="font-size: 14px;">Realiza tu primera venta para comenzar</p>
                                <button onclick="crearVentasPrueba(); renderSalesHistory();" style="margin-top: 16px; padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer;">
                                    Crear Ventas de Prueba
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                console.log('‚úÖ Mensaje "no hay ventas" insertado');
                return;
            }

            console.log('üé® Construyendo tabla con', sales.length, 'ventas');
            salesHistory.innerHTML = '';
            
            let processedCount = 0;
            sales.slice(0, 10).forEach((sale, index) => { // Mostrar solo las √∫ltimas 10
                console.log(`üéØ Procesando venta ${index + 1}:`, sale.numeroVenta || sale.saleNumber);
                
                try {
                    const row = document.createElement('tr');
                    
                    // Usar las propiedades correctas seg√∫n la estructura de datos
                    const fecha = sale.fecha || sale.date || new Date().toISOString();
                    const numeroVenta = sale.numeroVenta || sale.saleNumber || 'N/A';
                    const clienteNombre = sale.clienteNombre || sale.customer || 'Cliente General';
                    const productos = sale.productos || sale.items || [];
                    const total = sale.total || 0;
                    const metodoPago = sale.metodoPago || sale.paymentMethod || 'efectivo';
                    const estado = sale.estado || 'completada';
                    
                    const itemsCount = productos.reduce ? productos.reduce((sum, item) => sum + (item.quantity || item.cantidad || 1), 0) : productos.length;
                    
                    row.innerHTML = `
                        <td>${new Date(fecha).toLocaleDateString('es-ES')}</td>
                        <td><strong>#${numeroVenta}</strong></td>
                        <td>${clienteNombre}</td>
                        <td>${itemsCount} productos</td>
                        <td style="color: #16a34a; font-weight: 600;">$${total.toFixed(2)}</td>
                        <td>${getPaymentMethodName(metodoPago)}</td>
                        <td>
                            <span class="status-badge" style="
                                padding: 4px 8px; 
                                border-radius: 12px; 
                                font-size: 12px; 
                                font-weight: 500;
                                background: ${estado === 'completada' ? '#dcfce7' : '#fef3c7'};
                                color: ${estado === 'completada' ? '#166534' : '#92400e'};
                            ">
                                ${estado}
                            </span>
                        </td>
                        <td>
                            <button onclick="verDetalleVenta('${sale.id}')" style="
                                padding: 4px 8px; 
                                background: #3b82f6; 
                                color: white; 
                                border: none; 
                                border-radius: 4px; 
                                font-size: 12px; 
                                cursor: pointer;
                            ">
                                Ver
                            </button>
                        </td>
                    `;
                    
                    salesHistory.appendChild(row);
                    processedCount++;
                    
                } catch (error) {
                    console.error(`‚ùå Error procesando venta ${index + 1}:`, error, sale);
                }
            });
            
            console.log(`‚úÖ renderSalesHistory completado: ${processedCount} filas agregadas al DOM`);
            console.log('üìä Estado final del elemento salesHistory:');
            console.log('   - children.length:', salesHistory.children.length);
            console.log('   - innerHTML.length:', salesHistory.innerHTML.length);
        }

        // Obtener nombre del cliente
        function getCustomerName(customerType) {
            const customers = {
                'general': 'Cliente General',
                'frequent': 'Cliente Frecuente',
                'corporate': 'Cliente Corporativo'
            };
            return customers[customerType] || customerType;
        }

        // Obtener nombre del m√©todo de pago
        function getPaymentMethodName(method) {
            const methods = {
                'contado': 'Contado',
                'credito': 'Cr√©dito', 
                'transferencia': 'Transferencia',
                'cash': 'Efectivo', // compatibilidad con datos antiguos
                'card': 'Tarjeta',
                'transfer': 'Transferencia',
                'check': 'Cheque'
            };
            return methods[method] || method;
        }

        // Ver detalles de venta
        function viewSaleDetails(saleId) {
            const sales = loadSales();
            const sale = sales.find(s => s.id === saleId);
            
            if (!sale) return;

            const itemsList = sale.items.map(item => 
                `‚Ä¢ ${item.name} (${item.code}) - Cantidad: ${item.quantity} - $${(item.salePrice * item.quantity).toFixed(2)}`
            ).join('\n');

            alert(`DETALLES DE VENTA #${sale.saleNumber}\n\n` +
                  `Fecha: ${new Date(sale.date).toLocaleString()}\n` +
                  `Cliente: ${getCustomerName(sale.customer)}\n` +
                  `M√©todo de Pago: ${getPaymentMethodName(sale.paymentMethod)}\n\n` +
                  `PRODUCTOS:\n${itemsList}\n\n` +
                  `Subtotal: $${sale.subtotal.toFixed(2)}\n` +
                  `Impuestos: $${sale.taxes.toFixed(2)}\n` +
                  `TOTAL: $${sale.total.toFixed(2)}`);
        }

        // Actualizar estad√≠sticas
        function updateStats() {
            const sales = loadSales();
            const today = new Date().toDateString();
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            // Ventas del d√≠a
            const dailySalesData = sales.filter(sale => 
                new Date(sale.date).toDateString() === today
            );
            const dailyTotal = dailySalesData.reduce((sum, sale) => sum + sale.total, 0);
            const dailyOrdersCount = dailySalesData.length;

            // Ventas del mes
            const monthlySalesData = sales.filter(sale => {
                const saleDate = new Date(sale.date);
                return saleDate.getMonth() === currentMonth && saleDate.getFullYear() === currentYear;
            });
            const monthlyTotal = monthlySalesData.reduce((sum, sale) => sum + sale.total, 0);

            // Ticket promedio
            const averageTicket = dailyOrdersCount > 0 ? dailyTotal / dailyOrdersCount : 0;

            // Actualizar DOM
            document.getElementById('dailySales').textContent = `$${dailyTotal.toFixed(2)}`;
            document.getElementById('monthlySales').textContent = `$${monthlyTotal.toFixed(2)}`;
            document.getElementById('dailyOrders').textContent = dailyOrdersCount;
            document.getElementById('averageTicket').textContent = `$${averageTicket.toFixed(2)}`;
        }

        // Funciones de exportaci√≥n y reportes
        function exportSales() {
            const sales = loadSales();
            
            if (sales.length === 0) {
                showNotification('No hay ventas para exportar', 'error');
                return;
            }

            let csvContent = "Fecha,N√∫mero Venta,Cliente,M√©todo Pago,Subtotal,Impuestos,Total\n";
            
            sales.forEach(sale => {
                const date = new Date(sale.date).toLocaleDateString();
                csvContent += `${date},#${sale.saleNumber},${getCustomerName(sale.customer)},${getPaymentMethodName(sale.paymentMethod)},${sale.subtotal.toFixed(2)},${sale.taxes.toFixed(2)},${sale.total.toFixed(2)}\n`;
            });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'ventas_aristore.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            showNotification('Ventas exportadas exitosamente', 'success');
        }

        function generateSalesReport() {
            const sales = loadSales();
            const totalSales = sales.reduce((sum, sale) => sum + sale.total, 0);
            const totalOrders = sales.length;
            const averageOrderValue = totalOrders > 0 ? totalSales / totalOrders : 0;

            const report = `REPORTE DE VENTAS - ARISTORE\n` +
                          `======================================\n\n` +
                          `üìä RESUMEN GENERAL:\n` +
                          `‚Ä¢ Total de ventas: ${totalOrders}\n` +
                          `‚Ä¢ Valor total vendido: $${totalSales.toFixed(2)}\n` +
                          `‚Ä¢ Ticket promedio: $${averageOrderValue.toFixed(2)}\n\n` +
                          `üìÖ Fecha del reporte: ${new Date().toLocaleDateString()}\n` +
                          `üïí Hora: ${new Date().toLocaleTimeString()}`;

            alert(report);
        }

        // Funci√≥n de notificaci√≥n
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6';
            
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${bgColor};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                z-index: 9999;
                font-weight: 500;
                max-width: 300px;
                animation: slideInRight 0.3s ease;
            `;
            
            const icon = type === 'success' ? 'fas fa-check-circle' : type === 'error' ? 'fas fa-exclamation-circle' : 'fas fa-info-circle';
            
            notification.innerHTML = `
                <i class="${icon}" style="margin-right: 8px;"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // Funciones del Modal
        let modalCart = [];

        function abrirModalVenta() {
            modalCart = [];
            // Recargar productos desde localStorage
            products = loadProducts();
            document.getElementById('modalVenta').style.display = 'block';
            document.getElementById('modalCustomerSelect').value = '';
            document.getElementById('modalPaymentMethod').value = '';
            cargarClientesModal();
            renderModalSelectedProducts();
            setupModalProductSearch();
            updateModalTotals();
        }

        function cerrarModalVenta() {
            document.getElementById('modalVenta').style.display = 'none';
            modalCart = [];
        }

        function cargarClientesModal() {
            const clientes = JSON.parse(localStorage.getItem('aristore_clientes')) || [];
            const select = document.getElementById('modalCustomerSelect');
            
            console.log('Clientes cargados:', clientes.length);
            console.log('Clientes en localStorage:', JSON.parse(localStorage.getItem('aristore_clientes') || '[]').length);
            
            // Limpiar opciones existentes (excepto la primera)
            select.innerHTML = '<option value="">Seleccionar cliente</option>';
            
            // Agregar clientes registrados
            clientes.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente.id;
                option.textContent = `${cliente.nombre} - ${cliente.email}`;
                select.appendChild(option);
            });
            
            // Agregar opci√≥n de cliente general si no hay clientes registrados
            if (clientes.length === 0) {
                const option = document.createElement('option');
                option.value = 'general';
                option.textContent = 'Cliente General';
                select.appendChild(option);
            }
        }

        function cargarProductosModal() {
            const container = document.getElementById('modalAvailableProducts');
            container.innerHTML = '';
            
            products.forEach(product => {
                if (product.stock > 0) {
                    const productCard = document.createElement('div');
                    productCard.style.cssText = `
                        background: white;
                        border: 1px solid #e2e8f0;
                        border-radius: 8px;
                        padding: 16px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        text-align: center;
                    `;
                    
                    productCard.innerHTML = `
                        <div style="font-weight: 600; color: #2d3748; margin-bottom: 8px;">${product.nombre}</div>
                        <div style="font-size: 14px; color: #718096; margin-bottom: 8px;">C√≥digo: ${product.codigo}</div>
                        <div style="font-size: 16px; font-weight: 700; color: #667eea; margin-bottom: 8px;">$${product.precio.toFixed(2)}</div>
                        <div style="font-size: 12px; color: #4a5568;">Stock: ${product.stock}</div>
                    `;
                    
                    productCard.addEventListener('mouseenter', () => {
                        productCard.style.transform = 'translateY(-2px)';
                        productCard.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
                    });
                    
                    productCard.addEventListener('mouseleave', () => {
                        productCard.style.transform = 'translateY(0)';
                        productCard.style.boxShadow = 'none';
                    });
                    
                    productCard.addEventListener('click', () => {
                        agregarProductoATabla(product);
                    });
                    
                    container.appendChild(productCard);
                }
            });
        }

        function agregarProductoAlModal(productId) {
            // Esta funci√≥n ya no se usa, ha sido reemplazada por agregarProductoAlCarrito
            agregarProductoAlCarrito(productId);
        }

        function renderModalSelectedProducts() {
            const tbody = document.getElementById('modalSelectedProducts');
            
            if (modalCart.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <p><strong>No hay productos seleccionados</strong></p>
                            <small>Busca y selecciona productos para agregar a la venta</small>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = modalCart.map(item => {
                const total = item.precio * item.quantity;
                return `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-box" style="color: #667eea;"></i>
                                <div>
                                    <div style="font-weight: 600; color: #1f2937;">${item.nombre}</div>
                                    <div style="font-size: 12px; color: #6b7280;">C√≥digo: ${item.codigo}</div>
                                </div>
                            </div>
                        </td>
                        <td style="text-align: center;">
                            <span style="background: ${item.stock <= 5 ? '#fee2e2' : item.stock <= 10 ? '#fef3c7' : '#d1fae5'}; 
                                         color: ${item.stock <= 5 ? '#dc2626' : item.stock <= 10 ? '#d97706' : '#059669'}; 
                                         padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">
                                ${item.stock}
                            </span>
                        </td>
                        <td>
                            <div class="quantity-controls-modal">
                                <button class="quantity-btn-modal" onclick="cambiarCantidadModal(${item.id}, -1)">-</button>
                                <input type="number" class="quantity-input-modal" value="${item.quantity}" min="1" max="${item.stock}" 
                                       onchange="setCantidadModal(${item.id}, this.value)">
                                <button class="quantity-btn-modal" onclick="cambiarCantidadModal(${item.id}, 1)">+</button>
                            </div>
                        </td>
                        <td style="text-align: right; font-weight: 600; color: #059669;">$${item.precio.toFixed(2)}</td>
                        <td style="text-align: right; font-weight: 700; color: #1f2937;">$${total.toFixed(2)}</td>
                        <td style="text-align: center;">
                            <button class="quantity-btn-modal" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);" 
                                    onclick="removerDelCarritoModal(${item.id})" title="Eliminar producto">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function setCantidadModal(productId, newQuantity) {
            const item = modalCart.find(item => item.id === productId);
            const product = products.find(p => p.id === productId);
            
            if (item && product) {
                const quantity = parseInt(newQuantity);
                if (quantity > 0 && quantity <= product.stock) {
                    item.quantity = quantity;
                    renderModalSelectedProducts();
                    updateModalTotals();
                } else {
                    showNotification(`Cantidad debe ser entre 1 y ${product.stock}`, 'error');
                    renderModalSelectedProducts(); // Restaurar valor anterior
                }
            }
        }

        function cambiarCantidadModal(productId, change) {
            const item = modalCart.find(item => item.id === productId);
            const product = products.find(p => p.id === productId);
            
            if (item && product) {
                const newQuantity = item.quantity + change;
                if (newQuantity > 0 && newQuantity <= product.stock) {
                    item.quantity = newQuantity;
                    renderModalSelectedProducts();
                    updateModalTotals();
                } else if (newQuantity <= 0) {
                    removerDelCarritoModal(productId);
                }
            }
        }

        function removerDelCarritoModal(productId) {
            modalCart = modalCart.filter(item => item.id !== productId);
            renderModalSelectedProducts();
            updateModalTotals();
            cargarYMostrarProductos(); // Actualizar la lista de productos disponibles
        }

        function updateModalTotals() {
            const subtotal = modalCart.reduce((sum, item) => sum + (item.precio * item.quantity), 0);
            const taxes = subtotal * 0.18; // 18% de impuestos
            const total = subtotal + taxes;
            const totalItems = modalCart.length;
            const totalUnits = modalCart.reduce((sum, item) => sum + item.quantity, 0);
            
            document.getElementById('modalSubtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('modalTaxes').textContent = `$${taxes.toFixed(2)}`;
            document.getElementById('modalFinalTotal').textContent = `$${total.toFixed(2)}`;
            document.getElementById('modalItemCount').textContent = totalItems;
            document.getElementById('modalTotalUnits').textContent = totalUnits;
            
            // Habilitar/deshabilitar bot√≥n de procesar venta
            const btnProcesar = document.getElementById('btnProcesarVenta');
            btnProcesar.disabled = modalCart.length === 0;
            
            if (modalCart.length === 0) {
                btnProcesar.style.opacity = '0.5';
                btnProcesar.style.cursor = 'not-allowed';
            } else {
                btnProcesar.style.opacity = '1';
                btnProcesar.style.cursor = 'pointer';
            }
        }

        function setupModalProductSearch() {
            cargarYMostrarProductos();
        }

        function cargarYMostrarProductos() {
            // Cargar productos directamente desde localStorage
            const productosStorage = localStorage.getItem('aristore_products');
            let productosInventario = [];
            
            if (productosStorage) {
                try {
                    productosInventario = JSON.parse(productosStorage);
                    console.log('üì¶ Productos raw desde localStorage:', productosInventario);
                    
                    // Verificar y limpiar datos de productos
                    productosInventario = productosInventario.map((producto, index) => {
                        // B√∫squeda exhaustiva del precio en diferentes propiedades
                        let precioEncontrado = 0;
                        const posiblesCamposPrecio = [
                            'salePrice', 'precio', 'price', 'precioVenta', 'precioUnitario', 'valor', 
                            'amount', 'cost', 'unitPrice', 'pricePerUnit'
                        ];
                        
                        for (const campo of posiblesCamposPrecio) {
                            if (producto[campo] !== undefined && producto[campo] !== null && producto[campo] !== '') {
                                const valor = Number(producto[campo]);
                                if (!isNaN(valor) && valor >= 0) {
                                    precioEncontrado = valor;
                                    break;
                                }
                            }
                        }
                        
                        // Si a√∫n no hay precio, buscar en cualquier propiedad que contenga n√∫meros
                        if (precioEncontrado === 0) {
                            for (const [key, value] of Object.entries(producto)) {
                                if (typeof value === 'number' && value > 0 && value < 1000000) {
                                    // Probablemente sea un precio si est√° en un rango razonable
                                    precioEncontrado = value;
                                    console.log(`‚ö†Ô∏è Precio inferido para ${producto.nombre || 'producto'} desde campo '${key}': ${value}`);
                                    break;
                                }
                            }
                        }
                        
                        const productoLimpio = {
                            id: producto.id || index + 1,
                            codigo: producto.codigo || producto.code || `PROD${String(index + 1).padStart(3, '0')}`,
                            nombre: producto.nombre || producto.name || producto.descripcion || `Producto ${index + 1}`,
                            precio: precioEncontrado,
                            stock: Number(producto.stock || producto.cantidad || producto.inventory || 0),
                            categoria: producto.categoria || producto.category || producto.tipo || 'General'
                        };
                        
                        console.log(`üîç Producto ${index + 1}:`, {
                            original: producto,
                            precioEncontrado: precioEncontrado,
                            resultado: productoLimpio
                        });
                        
                        return productoLimpio;
                    }).filter(producto => 
                        producto.nombre && 
                        producto.nombre !== 'Producto sin nombre' && 
                        !producto.nombre.toLowerCase().includes('undefined')
                    );
                    
                    console.log('üì¶ Productos procesados:', productosInventario);
                } catch (error) {
                    console.error('Error al parsear productos:', error);
                    productosInventario = [];
                }
            }

            console.log('ÔøΩ Productos encontrados en localStorage:', productosInventario.length);
            console.log('üìã Datos de productos:', productosInventario);

            mostrarProductosEnGrid(productosInventario);
        }

        function mostrarProductosEnGrid(productos) {
            const productList = document.getElementById('modalProductList');
            
            if (!productos || productos.length === 0) {
                productList.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #64748b;">
                        <div style="background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); border-radius: 20px; padding: 40px; border: 2px dashed #cbd5e1;">
                            <i class="fas fa-warehouse" style="font-size: 64px; color: #94a3b8; margin-bottom: 24px; display: block;"></i>
                            <h3 style="color: #475569; margin-bottom: 12px; font-size: 24px;">Inventario Vac√≠o</h3>
                            <p style="color: #64748b; margin-bottom: 24px; font-size: 16px;">No se encontraron productos en el inventario</p>
                            <a href="inventario.html" style="display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-decoration: none; padding: 12px 24px; border-radius: 12px; font-weight: 600; transition: transform 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <i class="fas fa-plus"></i>
                                Agregar Productos al Inventario
                            </a>
                        </div>
                    </div>
                `;
                return;
            }

            // Filtrar solo productos con stock
            const productosConStock = productos.filter(p => p.stock && p.stock > 0);
            
            if (productosConStock.length === 0) {
                productList.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #64748b;">
                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 20px; padding: 40px; border: 2px dashed #f59e0b;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 64px; color: #f59e0b; margin-bottom: 24px; display: block;"></i>
                            <h3 style="color: #92400e; margin-bottom: 12px; font-size: 24px;">Sin Stock Disponible</h3>
                            <p style="color: #a16207; margin-bottom: 16px; font-size: 16px;">Hay ${productos.length} productos pero todos est√°n agotados</p>
                            <a href="inventario.html" style="display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; text-decoration: none; padding: 12px 24px; border-radius: 12px; font-weight: 600; transition: transform 0.3s ease;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
                                <i class="fas fa-boxes"></i>
                                Reabastecer Inventario
                            </a>
                        </div>
                    </div>
                `;
                return;
            }

            // Mostrar productos en grid profesional
            const productosHTML = productosConStock.map(producto => {
                const enCarrito = modalCart.some(item => item.id == producto.id);
                const stockNivel = producto.stock <= 5 ? 'critico' : producto.stock <= 15 ? 'bajo' : 'normal';
                const stockColor = stockNivel === 'critico' ? '#ef4444' : stockNivel === 'bajo' ? '#f59e0b' : '#10b981';
                const stockBg = stockNivel === 'critico' ? '#fef2f2' : stockNivel === 'bajo' ? '#fffbeb' : '#f0fdf4';
                
                return `
                    <div class="producto-card-simple ${enCarrito ? 'ya-agregado' : ''}" onclick="${enCarrito ? '' : `agregarProductoAlCarrito(${producto.id})`}">
                        <div class="producto-content-simple">
                            <h4 class="producto-nombre-simple">${producto.nombre}</h4>
                            <div class="producto-stock-simple" style="background: ${stockBg}; color: ${stockColor};">
                                <i class="fas fa-cubes"></i>
                                <span>Stock: ${producto.stock}</span>
                            </div>
                        </div>
                        
                        <div class="producto-accion-simple">
                            <button class="btn-agregar-simple ${enCarrito ? 'agregado' : ''}">
                                <i class="fas fa-${enCarrito ? 'check' : 'plus'}"></i>
                                ${enCarrito ? 'Agregado' : 'Agregar'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            productList.innerHTML = `
                <div class="productos-header">
                    <h4 style="margin: 0; color: #374151; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-boxes" style="color: #667eea;"></i>
                        Productos Disponibles (${productosConStock.length})
                    </h4>
                    <div style="font-size: 14px; color: #6b7280;">
                        ${productos.length} productos en inventario ‚Ä¢ ${productosConStock.length} con stock
                    </div>
                </div>
                <div class="productos-grid-nueva">
                    ${productosHTML}
                </div>
            `;
        }

        function agregarProductoAlCarrito(productId) {
            // Cargar productos actualizados
            const productosStorage = localStorage.getItem('aristore_products');
            if (!productosStorage) return;
            
            const productos = JSON.parse(productosStorage);
            const producto = productos.find(p => p.id == productId); // Usar == para comparaci√≥n m√°s flexible
            
            if (!producto) {
                showNotification('Producto no encontrado', 'error');
                return;
            }
            
            // Normalizar datos del producto
            const productoNormalizado = {
                id: producto.id,
                codigo: producto.codigo || 'N/A',
                nombre: producto.nombre || producto.name || 'Producto sin nombre',
                precio: Number(producto.salePrice || producto.precio || producto.price || 0),
                stock: Number(producto.stock || producto.cantidad || 0),
                categoria: producto.categoria || producto.category || 'General'
            };
            
            if (productoNormalizado.stock <= 0) {
                showNotification('Producto sin stock disponible', 'error');
                return;
            }
            
            // Verificar si ya est√° en el carrito
            if (modalCart.some(item => item.id == productId)) {
                showNotification('Producto ya agregado al carrito', 'info');
                return;
            }
            
            // Agregar al carrito
            modalCart.push({
                id: productoNormalizado.id,
                codigo: productoNormalizado.codigo,
                nombre: productoNormalizado.nombre,
                precio: productoNormalizado.precio,
                stock: productoNormalizado.stock,
                quantity: 1
            });
            
            // Actualizar interfaz
            renderModalSelectedProducts();
            updateModalTotals();
            cargarYMostrarProductos(); // Refrescar lista de productos
            
            showNotification(`${productoNormalizado.nombre} agregado al carrito`, 'success');
        }
        function mostrarTodosLosProductosDisponibles() {
            const productList = document.getElementById('modalProductList');
            const productosDisponibles = products.filter(product => product.stock > 0);
            
            if (productosDisponibles.length === 0) {
                productList.innerHTML = `
                    <div class="empty-state" style="padding: 40px; text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #f59e0b; margin-bottom: 16px;"></i>
                        <p><strong>No hay productos disponibles</strong></p>
                        <small>Todos los productos est√°n agotados</small>
                    </div>
                `;
                return;
            }

            productList.innerHTML = productosDisponibles.map(product => {
                const stockClass = product.stock <= 5 ? 'stock-bajo' : 
                                 product.stock <= 10 ? 'stock-medio' : 'stock-alto';
                
                const enCarrito = modalCart.some(item => item.id === product.id);
                const cardClass = enCarrito ? 'producto-card disabled' : 'producto-card';
                
                return `
                    <div class="${cardClass}" onclick="${enCarrito ? '' : `agregarProductoAlModal(${product.id})`}">
                        <div class="producto-header">
                            <div class="producto-info">
                                <h4>${product.nombre}</h4>
                                <div class="producto-codigo">
                                    <i class="fas fa-barcode"></i> ${product.codigo}
                                </div>
                            </div>
                            <div class="producto-stock ${stockClass}">
                                <i class="fas fa-cubes"></i>
                                ${product.stock}
                            </div>
                        </div>
                        <div class="producto-precio">
                            <div class="precio-valor">$${product.precio.toFixed(2)}</div>
                            <button class="btn-agregar" ${enCarrito ? 'disabled' : ''}>
                                <i class="fas fa-${enCarrito ? 'check' : 'plus'}"></i>
                                ${enCarrito ? 'Agregado' : 'Agregar'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function procesarVentaModal() {
            const customer = document.getElementById('modalCustomerSelect').value;
            const paymentMethod = document.getElementById('modalPaymentMethod').value;
            
            if (!customer || !paymentMethod) {
                showNotification('Por favor completa todos los campos requeridos', 'error');
                return;
            }
            
            if (modalCart.length === 0) {
                showNotification('Agrega productos al carrito', 'error');
                return;
            }
            
            // Obtener nombre del cliente
            let clienteNombre = 'Cliente General';
            if (customer !== 'general') {
                const clientes = JSON.parse(localStorage.getItem('aristore_clientes')) || [];
                const clienteEncontrado = clientes.find(c => c.id == customer);
                if (clienteEncontrado) {
                    clienteNombre = clienteEncontrado.nombre;
                }
            }
            
            const subtotal = modalCart.reduce((sum, item) => sum + (item.precio * item.quantity), 0);
            const taxes = subtotal * 0.18;
            const total = subtotal + taxes;
            
            // Generar n√∫mero de venta
            const numeroVenta = `V-${String(Date.now()).slice(-6)}`;
            
            const sale = {
                id: Date.now(),
                numeroVenta: numeroVenta,
                fecha: new Date().toISOString(),
                clienteNombre: clienteNombre,
                clienteId: customer,
                metodoPago: paymentMethod,
                productos: modalCart.map(item => ({
                    id: item.id,
                    nombre: item.nombre,
                    codigo: item.codigo,
                    precio: item.precio,
                    cantidad: item.quantity,
                    subtotal: item.precio * item.quantity
                })),
                subtotal: subtotal,
                impuestos: taxes,
                total: total,
                estado: 'completada'
            };
            
            console.log('üíæ Guardando venta:', sale);
            saveSale(sale);
            
            // Verificar que se guard√≥ correctamente
            const salesAfterSave = loadSales();
            console.log('‚úÖ Ventas despu√©s de guardar:', salesAfterSave.length);
            console.log('üìã √öltima venta guardada:', salesAfterSave[0]);
            
            // Actualizar stock en el inventario
            modalCart.forEach(item => {
                const product = products.find(p => p.id === item.id);
                if (product) {
                    product.stock -= item.quantity;
                }
            });
            localStorage.setItem('aristore_products', JSON.stringify(products));
            
            showNotification(`Venta procesada exitosamente. Total: $${total.toFixed(2)}`, 'success');
            cerrarModalVenta();
            renderSalesHistory();
            updateStats();
        }

        // Cerrar modal al hacer click fuera
        window.onclick = function(event) {
            const modal = document.getElementById('modalVenta');
            if (event.target === modal) {
                cerrarModalVenta();
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ P√°gina de ventas cargada');
            
            try {
                // Verificar localStorage
                if (!window.localStorage) {
                    console.error('‚ùå localStorage no disponible');
                    alert('Tu navegador no soporta localStorage. Las ventas no se guardar√°n.');
                    return;
                }
                
                // Cargar productos globalmente
                products = loadProducts();
                console.log('üì¶ Productos cargados:', products.length);
                console.log('üìã Lista de productos:', products);
                
                // Verificar ventas existentes con logs detallados
                console.log('üîç Verificando ventas existentes...');
                const existingSales = loadSales();
                console.log('üí∞ Ventas existentes:', existingSales.length);
                
                if (existingSales.length > 0) {
                    console.log('üìÑ Primeras 3 ventas:', existingSales.slice(0, 3));
                }
                
                // Configurar interfaz
                setupProductSearch();
                console.log('üîç Configurando historial de ventas...');
                renderSalesHistory();
                console.log('üìä Actualizando estad√≠sticas...');
                updateStats();
                renderCart();
                
                // Verificaci√≥n de persistencia despu√©s de la carga inicial
                setTimeout(() => {
                    verificarPersistencia();
                }, 1000);
                
                console.log('‚úÖ Inicializaci√≥n completada exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error cr√≠tico en inicializaci√≥n:', error);
                alert('Error al inicializar la aplicaci√≥n. Por favor, recarga la p√°gina.');
            }
            
            // Verificar ventas cada 30 segundos para debug
            setInterval(() => {
                const currentSales = loadSales();
                if (currentSales.length > 0) {
                    console.log('üîÑ Verificaci√≥n peri√≥dica - Ventas en localStorage:', currentSales.length);
                }
            }, 30000);
        });

        // Verificar antes de cerrar la ventana
        window.addEventListener('beforeunload', function(e) {
            const currentSales = loadSales();
            console.log('üö™ Cerrando ventana - Ventas guardadas:', currentSales.length);
        });

        // Funci√≥n de debugging disponible globalmente
        window.verificarDatos = function() {
            console.log('=== VERIFICACI√ìN DE DATOS ===');
            console.log('Productos en variable global:', products.length);
            console.log('Productos en localStorage:', JSON.parse(localStorage.getItem('aristore_products') || '[]').length);
            console.log('Clientes en localStorage:', JSON.parse(localStorage.getItem('aristore_clientes') || '[]').length);
            console.log('Modal cart:', modalCart);
            console.log('Lista de productos:', products);
            console.log('Lista de clientes:', JSON.parse(localStorage.getItem('aristore_clientes') || '[]'));
        };

        // Funci√≥n para limpiar y regenerar productos
        window.limpiarProductos = function() {
            console.log('üßπ Limpiando productos...');
            localStorage.removeItem('aristore_products');
            products = loadProducts(); // Esto crear√° productos de ejemplo
            console.log('‚úÖ Productos regenerados:', products);
            if (document.getElementById('modalVenta').style.display === 'block') {
                cargarYMostrarProductos(); // Refrescar modal si est√° abierto
            }
        };

        // Funci√≥n para inspeccionar localStorage completo
        window.inspeccionarStorage = function() {
            console.log('=== INSPECCI√ìN COMPLETA DE LOCALSTORAGE ===');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                console.log(`${key}:`, value);
                if (key.includes('aristore')) {
                    try {
                        const parsed = JSON.parse(value);
                        console.log(`${key} (parsed):`, parsed);
                    } catch (e) {
                        console.log(`${key} (no JSON):`, value);
                    }
                }
            }
        };

        // Funci√≥n para diagnosticar problemas de precios
        window.diagnosticarPrecios = function() {
            console.log('=== DIAGN√ìSTICO DE PRECIOS ===');
            const productosStorage = localStorage.getItem('aristore_products');
            
            if (!productosStorage) {
                console.log('‚ùå No hay productos en localStorage');
                return;
            }
            
            const productos = JSON.parse(productosStorage);
            console.log(`üì¶ Total de productos: ${productos.length}`);
            
            productos.forEach((producto, index) => {
                console.log(`\nüîç Producto ${index + 1}:`);
                console.log('- Datos completos:', producto);
                
                // Buscar todas las propiedades que podr√≠an ser precios
                const posiblesPrecios = {};
                for (const [key, value] of Object.entries(producto)) {
                    if (typeof value === 'number' || (!isNaN(Number(value)) && value !== '')) {
                        posiblesPrecios[key] = value;
                    }
                }
                
                console.log('- Posibles campos de precio:', posiblesPrecios);
                console.log('- Precio asignado:', Number(producto.precio || producto.price || 0));
            });
        };

        // Funci√≥n para fijar precios manualmente
        window.fijarPrecios = function() {
            const productosStorage = localStorage.getItem('aristore_products');
            if (!productosStorage) return;
            
            const productos = JSON.parse(productosStorage);
            const productosConPrecio = productos.map((producto, index) => {
                // Si no tiene precio v√°lido, asignar uno basado en el tipo de producto
                let precioAsignado = Number(producto.precio || producto.price || 0);
                
                if (precioAsignado === 0) {
                    // Asignar precios por defecto basados en categor√≠as o nombres
                    const nombre = (producto.nombre || producto.name || '').toLowerCase();
                    
                    if (nombre.includes('laptop') || nombre.includes('computadora')) {
                        precioAsignado = 12999.99;
                    } else if (nombre.includes('mouse') || nombre.includes('rat√≥n')) {
                        precioAsignado = 299.99;
                    } else if (nombre.includes('teclado') || nombre.includes('keyboard')) {
                        precioAsignado = 899.99;
                    } else if (nombre.includes('monitor') || nombre.includes('pantalla')) {
                        precioAsignado = 3999.99;
                    } else if (nombre.includes('celular') || nombre.includes('tel√©fono')) {
                        precioAsignado = 8999.99;
                    } else {
                        // Precio gen√©rico
                        precioAsignado = 199.99;
                    }
                }
                
                return {
                    ...producto,
                    precio: precioAsignado
                };
            });
            
            localStorage.setItem('aristore_products', JSON.stringify(productosConPrecio));
            console.log('‚úÖ Precios fijados para todos los productos');
            
            // Recargar productos
            products = loadProducts();
            if (document.getElementById('modalVenta').style.display === 'block') {
                cargarYMostrarProductos();
            }
            
            return productosConPrecio;
        };

        // Funci√≥n para crear productos de prueba con precios
        window.crearProductosPrueba = function() {
            const productosEjemplo = [
                {
                    id: 1,
                    codigo: 'LAP001',
                    nombre: 'Laptop HP Pavilion',
                    salePrice: 12999.99,
                    stock: 15,
                    categoria: 'Electr√≥nicos'
                },
                {
                    id: 2,
                    codigo: 'MOU001',
                    nombre: 'Mouse Logitech MX Master',
                    salePrice: 1299.50,
                    stock: 25,
                    categoria: 'Accesorios'
                },
                {
                    id: 3,
                    codigo: 'TEC001',
                    nombre: 'Teclado Mec√°nico RGB',
                    salePrice: 2499.00,
                    stock: 8,
                    categoria: 'Accesorios'
                },
                {
                    id: 4,
                    codigo: 'MON001',
                    nombre: 'Monitor 24" Full HD',
                    salePrice: 4599.99,
                    stock: 12,
                    categoria: 'Electr√≥nicos'
                }
            ];
            
            localStorage.setItem('aristore_products', JSON.stringify(productosEjemplo));
            console.log('‚úÖ Productos de prueba creados:', productosEjemplo);
            
            // Recargar productos en la variable global
            products = loadProducts();
            
            // Si el modal est√° abierto, refrescar
            if (document.getElementById('modalVenta').style.display === 'block') {
                cargarYMostrarProductos();
            }
            
            return productosEjemplo;
        }

        // === FUNCIONES DE DIAGN√ìSTICO AVANZADO ===
        window.diagnosticarPersistencia = function() {
            console.log('üîç === DIAGN√ìSTICO COMPLETO DE PERSISTENCIA ===');
            
            // 1. Estado actual del localStorage
            console.log('1Ô∏è‚É£ Estado actual del localStorage:');
            const allKeys = Object.keys(localStorage);
            console.log('   Todas las claves:', allKeys);
            
            const salesKeys = allKeys.filter(key => key.includes('sales') || key.includes('ventas') || key.includes('aristore'));
            console.log('   Claves relacionadas con ventas:', salesKeys);
            
            salesKeys.forEach(key => {
                const data = localStorage.getItem(key);
                console.log(`   ${key}:`, data ? `${data.length} caracteres` : 'vac√≠o');
                if (data && data.length < 200) {
                    console.log(`      Contenido: ${data}`);
                }
            });
            
            // 2. Probar escritura y lectura b√°sica
            console.log('2Ô∏è‚É£ Prueba de escritura y lectura b√°sica:');
            const testKey = 'test_persistence_' + Date.now();
            const testData = JSON.stringify([{id: 'test', fecha: new Date().toISOString(), total: 100}]);
            
            try {
                localStorage.setItem(testKey, testData);
                console.log('   ‚úÖ Escritura exitosa');
                
                const readBack = localStorage.getItem(testKey);
                if (readBack === testData) {
                    console.log('   ‚úÖ Lectura exitosa - datos coinciden');
                } else {
                    console.log('   ‚ùå Lectura fall√≥ - datos no coinciden');
                }
                
                localStorage.removeItem(testKey);
                console.log('   ‚úÖ Limpieza completada');
                
            } catch (error) {
                console.error('   ‚ùå Error en prueba de persistencia:', error);
            }
            
            // 3. Verificar funci√≥n loadSales espec√≠ficamente
            console.log('3Ô∏è‚É£ Verificando funci√≥n loadSales:');
            try {
                const loadedSales = loadSales();
                console.log('   üì¶ loadSales() retorn√≥:', loadedSales.length, 'ventas');
                
                if (loadedSales.length > 0) {
                    console.log('   üìù Primera venta cargada:', loadedSales[0]);
                    console.log('   üîç Estructura de la primera venta:', Object.keys(loadedSales[0]));
                }
                
            } catch (error) {
                console.error('   ‚ùå Error en loadSales():', error);
            }
            
            // 4. Verificar el elemento DOM
            console.log('4Ô∏è‚É£ Verificando elemento DOM:');
            const historyElement = document.getElementById('salesHistory');
            if (historyElement) {
                console.log('   ‚úÖ Elemento salesHistory encontrado');
                console.log('   üìã Contenido actual:', historyElement.innerHTML.length, 'caracteres');
                console.log('   üè∑Ô∏è Tag name:', historyElement.tagName);
                console.log('   üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Elementos hijos:', historyElement.children.length);
                
                // Forzar re-renderizado
                renderSalesHistory();
                console.log('   üîÑ Re-renderizado forzado completado');
                console.log('   üìã Contenido despu√©s de render:', historyElement.innerHTML.length, 'caracteres');
                console.log('   üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Elementos hijos despu√©s de render:', historyElement.children.length);
                
            } else {
                console.error('   ‚ùå Elemento salesHistory NO encontrado en el DOM');
                console.log('   üîç Elementos disponibles con ID que contienen "sales":');
                const allElements = document.querySelectorAll('[id*="sales"]');
                allElements.forEach(el => console.log(`      ${el.id}: ${el.tagName}`));
            }
            
            // 5. Prueba de ciclo completo
            console.log('5Ô∏è‚É£ Prueba de ciclo completo (crear, guardar, cargar, mostrar):');
            
            const ventaPrueba = {
                id: Date.now() + Math.random(),
                numeroVenta: 'DIAG-' + Date.now(),
                fecha: new Date().toISOString(),
                clienteNombre: 'Cliente Diagn√≥stico',
                productos: [{nombre: 'Producto Prueba', precio: 123, cantidad: 1}],
                total: 123,
                metodoPago: 'efectivo',
                estado: 'completada'
            };
            
            console.log('   üìù Creando venta de prueba:', ventaPrueba.numeroVenta);
            
            try {
                saveSale(ventaPrueba);
                console.log('   üíæ Venta guardada');
                
                const salesAfterSave = loadSales();
                console.log('   üì¶ Ventas despu√©s de guardar:', salesAfterSave.length);
                
                const found = salesAfterSave.find(s => s.numeroVenta === ventaPrueba.numeroVenta);
                if (found) {
                    console.log('   ‚úÖ Venta de prueba encontrada en datos cargados');
                } else {
                    console.log('   ‚ùå Venta de prueba NO encontrada en datos cargados');
                }
                
                renderSalesHistory();
                console.log('   üé® Historial re-renderizado');
                
            } catch (error) {
                console.error('   ‚ùå Error en prueba de ciclo completo:', error);
            }
            
            console.log('üîç === FIN DIAGN√ìSTICO COMPLETO ===');
        };

        // === FUNCIONES DE DEBUG PARA VENTAS ===
        window.debugVentas = function() {
            console.log('üîç DEBUG VENTAS:');
            console.log('Storage Key:', SALES_STORAGE_KEY);
            
            // Verificar localStorage directamente
            const rawData = localStorage.getItem(SALES_STORAGE_KEY);
            console.log('Raw data from localStorage:', rawData);
            
            const sales = loadSales();
            console.log('Sales loaded:', sales);
            console.log('Sales count:', sales.length);
            
            // Mostrar todas las claves de localStorage relacionadas con aristore
            console.log('Todas las claves de localStorage con "aristore":');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.includes('aristore')) {
                    const value = localStorage.getItem(key);
                    console.log(`${key}: ${value ? value.length + ' caracteres' : 'vac√≠o'}`);
                }
            }
            
            if (sales.length === 0) {
                console.log('‚ö†Ô∏è No hay ventas, creando ventas de prueba...');
                crearVentasPrueba();
            } else {
                console.log('‚úÖ Renderizando historial...');
                renderSalesHistory();
                updateStats();
            }
        };

        // Funci√≥n para limpiar todas las ventas
        window.limpiarVentas = function() {
            localStorage.removeItem(SALES_STORAGE_KEY);
            console.log('üßπ Ventas eliminadas del localStorage');
            renderSalesHistory();
            updateStats();
        };

        // Funci√≥n para verificar persistencia de ventas
        window.verificarPersistencia = function() {
            console.log('üîç VERIFICANDO PERSISTENCIA DE VENTAS:');
            
            // Crear una venta de prueba
            const ventaPrueba = {
                id: Date.now(),
                numeroVenta: 'TEST-001',
                fecha: new Date().toISOString(),
                clienteNombre: 'Cliente de Prueba',
                clienteId: 'test',
                metodoPago: 'efectivo',
                productos: [
                    { id: 1, nombre: 'Producto Test', precio: 100, cantidad: 1 }
                ],
                subtotal: 100,
                impuestos: 18,
                total: 118,
                estado: 'completada'
            };
            
            console.log('üíæ Guardando venta de prueba...');
            saveSale(ventaPrueba);
            
            console.log('üîç Verificando despu√©s de guardar...');
            const ventasDespues = loadSales();
            console.log('Ventas encontradas:', ventasDespues.length);
            
            // Simular recarga de p√°gina
            console.log('üîÑ Simulando recarga...');
            setTimeout(() => {
                const ventasDespuesRecarga = loadSales();
                console.log('Ventas despu√©s de "recarga":', ventasDespuesRecarga.length);
                
                if (ventasDespuesRecarga.length > 0) {
                    console.log('‚úÖ Las ventas persisten correctamente');
                } else {
                    console.log('‚ùå Las ventas se perdieron');
                }
                
                renderSalesHistory();
            }, 1000);
        };

        // FUNCI√ìN DE PRUEBA COMPLETA - Ejecuta en consola: pruebaCompleta()
        window.pruebaCompleta = function() {
            console.log('üöÄ INICIANDO PRUEBA COMPLETA DEL SISTEMA DE VENTAS');
            console.log('='.repeat(50));
            
            // Paso 1: Limpiar datos existentes
            console.log('üßπ Paso 1: Limpiando datos existentes...');
            localStorage.removeItem(SALES_STORAGE_KEY);
            
            // Paso 2: Crear venta de prueba directamente
            console.log('üíæ Paso 2: Creando venta de prueba...');
            const ventaPrueba = {
                id: Date.now(),
                numeroVenta: 'PRUEBA-001',
                fecha: new Date().toISOString(),
                clienteNombre: 'Cliente de Prueba',
                clienteId: 'general',
                metodoPago: 'efectivo',
                productos: [
                    { id: 1, nombre: 'Producto Test', precio: 500, cantidad: 2, subtotal: 1000 }
                ],
                subtotal: 1000,
                impuestos: 180,
                total: 1180,
                estado: 'completada'
            };
            
            // Paso 3: Guardar usando saveSale
            console.log('üíΩ Paso 3: Guardando venta...');
            saveSale(ventaPrueba);
            
            // Paso 4: Verificar que se guard√≥
            console.log('üîç Paso 4: Verificando guardado...');
            const ventas = loadSales();
            console.log('Ventas cargadas:', ventas.length);
            console.log('Primera venta:', ventas[0]);
            
            // Paso 5: Verificar que el elemento DOM existe
            console.log('üîç Paso 5: Verificando elemento DOM...');
            const tbody = document.getElementById('salesHistory');
            console.log('Elemento salesHistory encontrado:', !!tbody);
            if (tbody) {
                console.log('Contenido actual del tbody:', tbody.innerHTML);
            }
            
            // Paso 6: Ejecutar renderSalesHistory
            console.log('üé® Paso 6: Ejecutando renderSalesHistory...');
            renderSalesHistory();
            
            // Paso 7: Verificar resultado final
            console.log('‚úÖ Paso 7: Verificando resultado...');
            if (tbody) {
                console.log('Contenido final del tbody:', tbody.innerHTML);
                const rows = tbody.querySelectorAll('tr');
                console.log('N√∫mero de filas encontradas:', rows.length);
            }
            
            // Paso 8: Actualizar estad√≠sticas
            console.log('üìä Paso 8: Actualizando estad√≠sticas...');
            updateStats();
            
            console.log('='.repeat(50));
            console.log('üéØ PRUEBA COMPLETA FINALIZADA');
        };

        window.crearVentasPrueba = function() {
            const ventasEjemplo = [
                {
                    id: Date.now(),
                    numeroVenta: 'V-001',
                    fecha: new Date().toISOString(),
                    clienteId: 1,
                    clienteNombre: 'Cliente Ejemplo',
                    productos: [
                        { id: 1, nombre: 'Laptop HP Pavilion', precio: 12999.99, cantidad: 1 }
                    ],
                    subtotal: 12999.99,
                    impuestos: 2339.99,
                    total: 15339.98,
                    metodoPago: 'efectivo',
                    estado: 'completada'
                },
                {
                    id: Date.now() + 1,
                    numeroVenta: 'V-002',
                    fecha: new Date(Date.now() - 86400000).toISOString(), // Ayer
                    clienteId: 2,
                    clienteNombre: 'Mar√≠a Garc√≠a',
                    productos: [
                        { id: 2, nombre: 'Mouse Logitech', precio: 1299.50, cantidad: 2 }
                    ],
                    subtotal: 2599.00,
                    impuestos: 467.82,
                    total: 3066.82,
                    metodoPago: 'tarjeta',
                    estado: 'completada'
                },
                {
                    id: Date.now() + 2,
                    numeroVenta: 'V-003',
                    fecha: new Date(Date.now() - 172800000).toISOString(), // Hace 2 d√≠as
                    clienteId: 3,
                    clienteNombre: 'Juan P√©rez',
                    productos: [
                        { id: 1, nombre: 'Laptop HP Pavilion', precio: 12999.99, cantidad: 1 },
                        { id: 3, nombre: 'Teclado Mec√°nico RGB', precio: 2499.00, cantidad: 1 }
                    ],
                    subtotal: 15498.99,
                    impuestos: 2789.82,
                    total: 18288.81,
                    metodoPago: 'transferencia',
                    estado: 'completada'
                }
            ];

            localStorage.setItem(SALES_STORAGE_KEY, JSON.stringify(ventasEjemplo));
            console.log('‚úÖ Ventas de prueba creadas:', ventasEjemplo);
            
            // Actualizar historial inmediatamente
            renderSalesHistory();
            updateStats();
            
            return ventasEjemplo;
        };

        // Animaciones CSS
        const styles = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = styles;
        document.head.appendChild(styleSheet);

        // === SOBRESCRIBIR FUNCIONES DE PERSISTENCIA ===
        // Soluci√≥n para el problema de persistencia
        
        console.log('üîß Aplicando fix de persistencia...');
        
        // Nueva funci√≥n de carga ultra-simple
        function loadSalesFixed() {
            try {
                const data = localStorage.getItem('aristore_sales');
                if (data) {
                    const parsed = JSON.parse(data);
                    console.log('‚úÖ loadSalesFixed: Cargadas', parsed.length, 'ventas');
                    return Array.isArray(parsed) ? parsed : [];
                }
                console.log('üìã loadSalesFixed: No hay datos');
                return [];
            } catch (error) {
                console.error('‚ùå loadSalesFixed error:', error);
                return [];
            }
        }
        
        // Nueva funci√≥n de guardado ultra-simple
        function saveSaleFixed(sale) {
            try {
                console.log('üíæ saveSaleFixed: Guardando venta', sale.numeroVenta);
                
                const sales = loadSalesFixed();
                sales.unshift(sale);
                
                localStorage.setItem('aristore_sales', JSON.stringify(sales));
                
                // Verificar inmediatamente
                const check = localStorage.getItem('aristore_sales');
                if (check) {
                    const checkParsed = JSON.parse(check);
                    console.log('‚úÖ saveSaleFixed: Guardado exitoso,', checkParsed.length, 'ventas total');
                    return true;
                }
                
                console.error('‚ùå saveSaleFixed: Fallo en guardado');
                return false;
            } catch (error) {
                console.error('‚ùå saveSaleFixed error:', error);
                return false;
            }
        }
        
        // Sobrescribir las funciones originales
        window.loadSales = loadSalesFixed;
        window.saveSale = saveSaleFixed;
        
        console.log('‚úÖ Fix de persistencia aplicado');
    </script>

    <!-- Modal Nueva Venta -->
    <div id="modalVenta" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-shopping-cart"></i>
                    Nueva Venta
                </h2>
                <button class="modal-close" onclick="cerrarModalVenta()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="modal-grid">
                    <div class="modal-left">
                        <!-- Informaci√≥n del Cliente y M√©todo de Pago -->
                        <div class="form-section">
                            <h3 class="form-section-title">
                                <i class="fas fa-user"></i>
                                Informaci√≥n de la Venta
                            </h3>
                            <div class="form-grid-modal">
                                <div class="form-group-modal">
                                    <label class="form-label-modal">Cliente *</label>
                                    <select id="modalCustomerSelect" class="form-select-modal" required>
                                        <option value="">Seleccionar cliente</option>
                                        <!-- Los clientes se cargar√°n din√°micamente -->
                                    </select>
                                </div>
                                <div class="form-group-modal">
                                    <label class="form-label-modal">M√©todo de Pago *</label>
                                    <select id="modalPaymentMethod" class="form-select-modal" required>
                                        <option value="">Seleccionar m√©todo</option>
                                        <option value="contado">Contado</option>
                                        <option value="credito">Cr√©dito</option>
                                        <option value="transferencia">Transferencia</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Productos Disponibles -->
                        <div class="form-section">
                            <h3 class="form-section-title">
                                <i class="fas fa-boxes"></i>
                                Productos Disponibles
                            </h3>
                            <div class="products-grid-container">
                                <div id="modalProductList" class="productos-disponibles"></div>
                            </div>
                        </div>

                        <!-- Productos Seleccionados -->
                        <div class="form-section">
                            <h3 class="form-section-title">
                                <i class="fas fa-list"></i>
                                Productos Seleccionados
                            </h3>
                            <div class="products-table-container">
                                <table class="products-table">
                                    <thead>
                                        <tr>
                                            <th><i class="fas fa-box"></i> Producto</th>
                                            <th><i class="fas fa-warehouse"></i> Stock</th>
                                            <th><i class="fas fa-sort-numeric-up"></i> Cantidad</th>
                                            <th><i class="fas fa-dollar-sign"></i> P. Unit.</th>
                                            <th><i class="fas fa-calculator"></i> Total</th>
                                            <th><i class="fas fa-cog"></i> Acci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody id="modalSelectedProducts">
                                        <tr>
                                            <td colspan="6" class="empty-state">
                                                <i class="fas fa-inbox"></i>
                                                <p><strong>No hay productos seleccionados</strong></p>
                                                <small>Busca y selecciona productos para agregar a la venta</small>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="modal-right">
                        <!-- Resumen de la Venta -->
                        <h3 class="form-section-title">
                            <i class="fas fa-calculator"></i>
                            Resumen de la Venta
                        </h3>
                        
                        <div class="summary-card">
                            <div class="summary-item">
                                <span><i class="fas fa-boxes"></i> Productos:</span>
                                <span id="modalItemCount">0</span>
                            </div>
                            <div class="summary-item">
                                <span><i class="fas fa-cubes"></i> Unidades:</span>
                                <span id="modalTotalUnits">0</span>
                            </div>
                            <div class="summary-item">
                                <span><i class="fas fa-receipt"></i> Subtotal:</span>
                                <span id="modalSubtotal">$0.00</span>
                            </div>
                            <div class="summary-item">
                                <span><i class="fas fa-percentage"></i> IVA (18%):</span>
                                <span id="modalTaxes">$0.00</span>
                            </div>
                            <div class="summary-total">
                                <span><i class="fas fa-money-bill-wave"></i> Total a Pagar:</span>
                                <span id="modalFinalTotal">$0.00</span>
                            </div>
                        </div>

                        <button id="btnProcesarVenta" class="btn-process-sale" onclick="procesarVentaModal()" disabled>
                            <i class="fas fa-credit-card"></i>
                            Procesar Venta
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
